<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width,initial-scale=1.0">
  <title>고객 상세 정보 보기</title>
  <!-- 베이스 기준: jQuery CDN + integrity 포함 -->
  <script src="https://code.jquery.com/jquery-3.7.1.js" integrity="sha256-eKhayi8LEQwp4NKxN+CfCh+3qOVUtJn3QNZ0TciWLP4="
    crossorigin="anonymous"></script>
  <!-- 베이스 기준: Vue 3 CDN -->
  <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>

  <!-- 외부에 보이는 디자인(스타일) 유지 -->
  <style>
    /* Layout */
    body {
      margin: 0;
      background: #f5f6f8;
      font-family: Arial, sans-serif;
    }

    #app {
      display: flex;
      justify-content: center;
      align-items: flex-start;
      min-height: 100vh;
      padding: 28px 12px;
      box-sizing: border-box;
    }

    .container {
      width: 980px;
      max-width: 100%;
      background: #fff;
      border-radius: 14px;
      box-shadow: 0 6px 16px rgba(0, 0, 0, .08);
      padding: 22px;
    }

    .title {
      margin: 0 0 16px;
      text-align: center;
      font-size: 1.4rem;
      font-weight: 800;
      color: #223;
    }

    /* Section */
    .section {
      margin-top: 22px;
    }

    .section__hd {
      margin: 0 0 10px;
      padding-bottom: 6px;
      font-size: 1.05rem;
      font-weight: 800;
      color: #2b3a55;
      border-bottom: 2px solid #e8eefc;
    }

    /* Cards */
    .card {
      background: #fff;
      border: 1px solid #e9edf3;
      border-radius: 12px;
      padding: 12px;
    }

    .profile {
      display: grid;
      grid-template-columns: 220px 1fr;
      gap: 16px;
      align-items: start;
      border: 1px solid #e9edf3;
      border-radius: 12px;
      padding: 14px;
      background: #fbfdff;
    }

    .photo-main {
      width: 180px;
      height: 180px;
      object-fit: cover;
      display: block;
      margin: 0 auto 10px;
      border-radius: 12px;
      border: 4px solid #f1f4ff;
    }

    .photo-sub {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 8px;
    }

    .photo-sub img {
      width: 100%;
      height: 70px;
      object-fit: cover;
      border-radius: 8px;
      border: 1px solid #eef1f5;
    }

    .pr {
      background: #f8f9fd;
      border: 1px solid #eef1f8;
      border-radius: 10px;
      padding: 10px;
      white-space: pre-line;
      line-height: 1.6;
      color: #334;
    }

    /* Info grid */
    .info-grid {
      display: grid;
      grid-template-columns: repeat(2, minmax(0, 1fr));
      gap: 10px;
      margin-top: 12px;
    }

    .info-item {
      background: #f8fafc;
      border: 1px solid #eef1f5;
      border-radius: 10px;
      padding: 10px;
      text-align: left;
    }

    .info-item b {
      display: block;
      color: #566;
      margin-bottom: 4px;
    }

    /* Tables */
    table {
      width: 100%;
      border-collapse: collapse;
    }

    th,
    td {
      border: 1px solid #e5e9f2;
      padding: 8px 10px;
      text-align: center;
    }

    thead th {
      background: #f6f9ff;
      color: #2b3a55;
      font-weight: 800;
    }

    tbody tr:nth-child(even) td {
      background: #fafcff;
    }

    tbody tr:hover td {
      background: #f0f6ff;
    }

    /* Buttons */
    .btn-row {
      text-align: center;
      margin-top: 16px;
    }

    .btn {
      display: inline-block;
      padding: 10px 16px;
      border-radius: 10px;
      border: none;
      background: #3a7afe;
      color: #fff;
      font-weight: 800;
      cursor: pointer;
      box-shadow: 0 4px 10px rgba(58, 122, 254, .18);
    }

    .btn+.btn {
      margin-left: 8px;
    }

    .btn:hover {
      background: #2b68ea;
    }

    /* Footer */
    .text-muted {
      text-align: center;
      margin-top: 14px;
      color: #666;
    }

    .copyright {
      color: #98a0aa;
      font-size: .9rem;
    }

    /* Responsive */
    @media (max-width:760px) {
      .profile {
        grid-template-columns: 1fr;
      }
    }
  </style>
</head>

<body>
  <div id="app">
    <!-- html코드는 id가 app인 태그 안에서 작업 -->
    <div class="container">
      <h2 class="title">고객 상세 정보 보기</h2>

      <!-- 상단 프로필 -->
      <div class="profile">
        <div class="card">
          <!-- <img :src="photos.main" alt="메인 사진" class="photo-main"> -->
          <!-- <img class="box2" :src="mainPhotoSrc()" width="170" height="200" style="cursor: pointer;"
            onclick="fnPopup2()"> -->
          <!-- 변경: 리스트와 동일 규칙(/server 접두) + 에러시 기본이미지 -->
          <img class="photo-main" :src="pfx(info.MAIN_PHOTO_URL)" @error="onImgError" alt="메인 사진">

          <!-- <div class="photo-sub">
            <img v-for="(s,i) in photos.sub" :key="'sub-'+i" :src="s" alt="보조 사진">
          </div> -->
        </div>

        <div class="card">
          <div class="section__hd">고객 소개</div>
          <div class="pr">{{ info.PR }}</div>

          <div class="info-grid">
            <div class="info-item"><b>회원번호</b>{{ info.MEMBER_NO }}</div>
            <div class="info-item"><b>성명</b>{{ info.NAME }}</div>
            <div class="info-item"><b>거주지</b>{{ info.ADDRESS }}</div>
            <div class="info-item"><b>전화번호</b>{{ info.PHONE }}</div>
            <div class="info-item"><b>이메일</b>{{ info.EMAIL }}</div>
            <div class="info-item"><b>출생년</b>{{ info.BIRTH_YEAR }}</div>

          </div>
        </div>
      </div>

      <!-- 신상 정보 -->
      <div class="section">
        <div class="section__hd">신상 정보</div>
        <div class="info-grid">
          <div class="info-item"><b>신장</b>{{ info.HEIGHT }}cm</div>
          <div class="info-item"><b>체중</b>{{ info.WEIGHT }}kg</div>
          <!-- <div class="info-item"><b>혈액형</b>{{ info.BLOOD_TYPE }}</div> -->
          <!-- <div class="info-item"><b>종교</b>{{ info.RELIGION }}</div> -->
          <!-- <div class="info-item"><b>취미</b>{{ info.HOBBY }}</div> -->
          <!-- <div class="info-item"><b>자격</b>{{ info.HOBBY }}</div> -->
          <div class="info-item"><b>성별</b>{{ info.GENDER }}</div>
        </div>
      </div>

      <!-- 학력 정보 -->
      <div class="section">
        <div class="section__hd">학력 정보</div>
        <table>
          <thead>
            <tr>
              <th>구분</th>
              <th>학교명</th>
              <th>전공</th>
              <th>입학년도</th>
              <th>졸업년도</th>
              <th>소재지</th>
            </tr>
          </thead>
          <tbody v-if="educations.length > 0">
            <tr v-for="(edu, i) in educations" :key="'edu-'+i">
              <td>{{ edu.level }}</td>
              <td>{{ edu.school }}</td>
              <td>{{ edu.major }}</td>
              <td>{{ edu.enter }}</td>
              <td>{{ edu.graduate }}</td>
              <td>{{ edu.area }}</td>
            </tr>
          </tbody>
          <tbody v-else>
            <tr>
              <td colspan="6">학력 정보가 없습니다.</td>
            </tr>
          </tbody>
        </table>
      </div>

      <!-- 직업 정보 -->
      <!-- <div class="section">
        <div class="section__hd">직업 정보</div>
        <table>
          <thead>
            <tr>
              <th>회사</th>
              <th>업종</th>
              <th>직원수</th>
              <th>부서</th>
              <th>직위</th>
              <th>소재지</th>
              <th>입사년</th>
            </tr>
          </thead>
          <tbody>
            <tr v-for="(job, j) in jobs" :key="'job-'+j">
              <td>{{ job.company }}</td>
              <td>{{ job.industry }}</td>
              <td>{{ job.headcount }}</td>
              <td>{{ job.dept }}</td>
              <td>{{ job.position }}</td>
              <td>{{ job.area }}</td>
              <td>{{ job.joined }}</td>
            </tr>
          </tbody>
        </table>
      </div> -->

      <!-- 가족 정보 -->
      <!-- <div class="section">
        <div class="section__hd">가족 정보</div>
        <table>
          <thead>
            <tr>
              <th>관계</th>
              <th>연령</th>
              <th>직업</th>
              <th>학력</th>
              <th>결혼</th>
              <th>동거</th>
              <th>거주지</th>
              <th>비고</th>
            </tr>
          </thead>
          <tbody>
            <tr v-for="(fam, k) in families" :key="'fam-'+k">
              <td>{{ fam.relation }}</td>
              <td>{{ fam.age }}</td>
              <td>{{ fam.job }}</td>
              <td>{{ fam.education }}</td>
              <td>{{ fam.married }}</td>
              <td>{{ fam.together }}</td>
              <td>{{ fam.area }}</td>
              <td>{{ fam.note }}</td>
            </tr>
          </tbody>
        </table>
      </div> -->


      <!-- 지도 섹션 (상세 화면 중간 어딘가 적당한 위치) -->
      <div class="section">
        <div class="section__hd">위치</div>
        <div id="map" style="width:100%;height:300px;border:1px solid #e9edf3;border-radius:10px;"></div>
        <div id="mapAddr" style="margin-top:8px;color:#666;font-size:.95rem;"></div>
      </div>



      <!-- 버튼 -->
      <div class="btn-row">
        <button class="btn" v-if="canEdit" @click="fnGoEdit">프로필 수정하기</button>
        <button class="btn" @click="fnGoList">목록으로</button>
      </div>

      <div class="text-muted">
        담당 데이터 입력자 : {{ info.CREATEBY }}
        <!-- / {{ manager.phone }} / -->
        <!-- <a :href="'mailto:'+manager.email">{{ manager.email }}</a> -->
      </div>
      <div class="text-muted copyright">Copyright © 전경환 All Rights Reserved.</div>
    </div>
  </div>

  <script>
    const app = Vue.createApp({
      data() {
        return {
          memberNo: "",
          info: {},
          photos: {
            main: "/lib/binaryread_photo.asp?memid=!!3331211122&photonum=1&size=0",
            sub: [
              "/lib/binaryread_photo.asp?memid=!!3331211122&photonum=1&size=0",
              "/lib/binaryread_photo.asp?memid=!!3331211122&photonum=2&size=0",
              "/html/myMeetingdiary/img/img-main-profile01.jpg"
            ]
          },
          profile: {
            memberNo: "1100010222",
            name: "더미테스트",
            pr: "더미고객의 특징입니다..\n순정파 스타일로 서로 마음이 맞으면 최선을 다해서 마음을 주는 스타일입니다.\n가끔 함께 야구장이나 공원 산책 좋아함",
            address: "더미인천광역시 연수구 원인재로",
            email: "uniline123@naver.com",
            phone: "010-7125-2266",
            birthYear: 9999
          },
          // details: {
          //   height: 170, weight: 67, bloodType: "B형", religion: "불교",
          //   hobby: "산책, 유튜브 시청", cert: "정보처리기사, 운전면허, SQLD, ADsP"
          // },
          educations: [
            //   { level: "더미고등학교", school: "더미연수", major: "더미인문계", enter: "2002", graduate: "2005", area: "인천" },
            //   { level: "더미대학교", school: "더미인천", major: "더미산업경영공학", enter: "2005", graduate: "2011", area: "인천" },
            //   { level: "더미대학원", school: "더미가천대", major: "더미모바일소프트웨어학", enter: "2015", graduate: "2017", area: "성남" }
          ],
          // jobs: [
          //   { company: "(주)귀뚜라미홀딩스", industry: "중견기업(비상장, 관리)", headcount: 177, dept: "경영정보팀", position: "과장", area: "서울 마곡", joined: "2024-03" },
          //   { company: "새롬씨앤씨", industry: "중소기업(비상장;관리)", headcount: 100, dept: "시스템정보팀", position: "과장", area: "", joined: "2021-10" }
          // ],
          // families: [
          //   { relation: "부", age: 68, job: "현직|제조업", education: "대학교", married: "기혼", together: "동거", area: "인천", note: "" },
          //   { relation: "모", age: 68, job: "현직|제조업", education: "대학(2,3년제)", married: "기혼", together: "동거", area: "인천", note: "" },
          //   { relation: "여동생", age: 27, job: "현직|제조업", education: "대학교", married: "미혼", together: "동거", area: "인천", note: "" }
          // ],
          manager: {
            name: "더미테스터", phone: "더미02-123-1234", email: "더미test@naver.com"
          },
          sessionId: "",        // 현재 로그인 사용자
          sessionStatus: "",    // 상태(필요시)
          canEdit: false,       // ⬅️ 작성자만 수정 가능 여부
          defaultPhoto: "../server/uploads/nouploadimg.png"   // 리스트에서 쓰던 거 그대로
        };
      },
      methods: {
        // 고객 기초? 정보 : jQuery AJAX 사용
        fnViewProfile: function () {
          let self = this;
          $.ajax({
            url: "http://localhost:3009/cms/customerinfo/",
            dataType: "json",
            type: "GET",
            data: { memberNo: self.memberNo },
            success: function (data) {
              if (!data) { alert("데이터가 없습니다."); return; }
              else {
                // alert("데이터가 있습니다.");
                // alert(JSON.stringify(data.info));

                self.info = data.info;
                self.canEdit = (self.sessionId === self.info.CREATEBY);
                // alert("사진 띄우기 진입직전");
                // mainPhotoSrc(); //이게 두번쨰로 호출되는 순간임
                // alert("사진 띄우기 탈출");

                // ✅ 지도 그리기 (DOM이 준비된 뒤 실행)
                self.$nextTick(() => self.drawMap());
              }


            }
          });
        },
        // ⬇️ 고객 학력 불러오기 
        fnLoadEducations: function () {
          let self = this;
          $.ajax({
            url: "http://localhost:3009/cms/customeredu",
            dataType: "json",
            type: "GET",
            data: { memberNo: self.memberNo },
            success: function (res) {
              // alert(JSON.stringify(res));
              // 서버가 배열로 주는 경우/객체에 list로 주는 경우 모두 대응
              const rows = Array.isArray(res) ? res : (res.list || []);
              // 오라클 컬럼은 대문자일 수 있으니 안전 매핑
              self.educations = rows.map(r => ({
                level: r.EDU_LEVEL || r.LEVEL || "",
                school: r.SCHOOLNAME || r.SCHOOL || "",
                major: r.MAJOR || "",
                enter: r.ENTER_YEAR || r.ENTER || "",
                graduate: r.GRAD_YEAR || r.GRADUATE || "",
                area: r.AREA || ""
              }));
            },
          });
        },


        mainPhotoSrc: function () {
          // alert("사진 띄우기 진입1");
          let self = this;
          // alert("사진 띄우기 진입2");
          // alert("MAIN_PHOTO_URL는 " + self.info.MAIN_PHOTO_URL);
          let u = ".." + self.info.MAIN_PHOTO_URL;
          // alert("MAIN_PHOTO_URL 앞에 .. 붙임 " + u);
          // alert("사진 띄우기 진입3");

          if (!u) {
            // alert("사진 띄우기 진입4");
            return '/photos/noimg.jpg'
            // alert("사진 띄우기 진입5");
          };
          // alert("사진 띄우기 진입6");
          // if (/^https?:\/\//i.test(u)) return u;   // http(s)://...
          // if (u.startsWith('/')) return u;         // /photos/cust010.jpg (캡처처럼)
          return `${u}`; // cust010.jpg → /photos/cust010.jpg
        },
        fnGoList: function () {
          location.href = "cms_customer_list.html";
        },
        // 수정 페이지로 이동
        fnGoEdit: function () {
          self = this;
          // self.memberNo는 쿼리에서 뽑아온 값, info.MEMBER_NO를 써도 OK
          location.href = `cms_customer_update.html?memberNo=${encodeURIComponent(self.memberNo)}`;
        },

        //사진관련250917----------------------------------------S
        // 리스트 화면과 동일: /server + 원본 경로
        pfx(p) {
          if (!p) return this.defaultPhoto;
          p = String(p).replace(/\\/g, '/');
          return `/server${p.startsWith('/') ? '' : '/'}${p}`;
        },
        onImgError(e) {
          e.target.onerror = null;
          e.target.src = this.defaultPhoto;
        },
        //사진관련250917----------------------------------------E

        //네이버지도250918
        drawMap() {
          // DB에서 온 좌표 사용 (열 이름은 대문자일 가능성)
          const lat = Number(this.info.LATITUDE || this.info.lat || this.info.latitude);
          const lng = Number(this.info.LONGITUDE || this.info.lng || this.info.longitude);
          const hasCoord = !isNaN(lat) && !isNaN(lng);

          const $addr = document.getElementById('mapAddr');
          if (!hasCoord) {
            if ($addr) $addr.textContent = '좌표 정보가 없습니다.';
            return;
          }

          const center = new naver.maps.LatLng(lat, lng);
          const map = new naver.maps.Map('map', { center, zoom: 14 });
          const marker = new naver.maps.Marker({ position: center, map });

          const addrText = this.info.ADDRESS || '';
          if ($addr) $addr.textContent = addrText;

          if (addrText) {
            const iw = new naver.maps.InfoWindow({
              content: `<div style="padding:6px 8px;font-size:12px;">${addrText}</div>`
            });
            iw.open(map, marker);
          }
        },

      },
      mounted() {
        // 처음 시작할 때 실행되는 부분
        let self = this;

        const queryParams = new URLSearchParams(window.location.search);
        self.memberNo = queryParams.get('memberNo') || ''; //get('MemberNo')는 내가 보낸, 요청한 파라미터 이름
        console.log("MemberNo ===>", self.memberNo); //내가 보내준 (요청한) 값 출력 가능


        //세션정보 꺼냄 꺼내자 마자 위에 선언한 변수 sessionId에 넣어버림 세션아이디의 값하고 info유저의 값하고 같을때만 버튼 보ㅈ줄꺼
        self.sessionId = sessionStorage.getItem("sessionId"); //set할때 이름이 sessionID이었음 그걸 get으로 꺼냄

        self.sessionStatus = sessionStorage.getItem("sessionStatus"); //로그인 할때 set했는데 그때 이름이  sessionStatus였음



        self.fnViewProfile();
        self.fnLoadEducations();
        // self.mainPhotoSrc();
      }
    });

    app.mount('#app');
  </script>
  <!-- (추가) 네이버 지도 JS: 콘솔의 Client ID 사용 -->
  <script src="https://oapi.map.naver.com/openapi/v3/maps.js?ncpClientId=jquy82alxa"></script>


</body>

</html>