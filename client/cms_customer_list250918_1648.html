<!DOCTYPE html>
<html lang="ko">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width,initial-scale=1.0">
  <title>고객 목록 및 검색</title>
  <script src="https://code.jquery.com/jquery-3.7.1.js" crossorigin="anonymous"></script>
  <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
  <script src="https://cdn.iamport.kr/v1/iamport.js"></script> <!-- 결제용 -->
  <style>
    /* ===== 기존 디자인 그대로 ===== */
    body {
      margin: 0;
      background: #f5f6f8;
      font-family: Arial, sans-serif;
      color: #222
    }

    #app {
      display: flex;
      justify-content: center;
      align-items: flex-start;
      min-height: 100vh;
      padding: 24px 12px;
      box-sizing: border-box
    }

    .container {
      width: 1100px;
      max-width: 100%;
      background: #fff;
      border-radius: 14px;
      padding: 18px;
      box-shadow: 0 8px 22px rgba(0, 0, 0, .08);
      border: 1px solid #eef2f7
    }

    .title {
      margin: 0 0 12px;
      text-align: center;
      font-size: 1.35rem;
      font-weight: 800;
      color: #223;
      display: flex;
      justify-content: space-between
    }

    .notice {
      background: #f8fbff;
      border: 1px solid #e6f0ff;
      color: #334;
      padding: 12px 14px;
      border-radius: 10px;
      line-height: 1.6
    }

    .warn {
      color: #c62828;
      font-weight: 800
    }

    .section {
      margin-top: 16px
    }

    .section__hd {
      margin: 0 0 10px;
      padding-bottom: 6px;
      font-size: 1.02rem;
      font-weight: 800;
      color: #2b3a55;
      border-bottom: 2px solid #e8eefc;
      display: flex;
      align-items: center
    }

    .btn {
      display: inline-block;
      padding: 10px 14px;
      border-radius: 10px;
      border: none;
      cursor: pointer;
      font-weight: 800;
      background: #3a7afe;
      color: #fff;
      box-shadow: 0 4px 10px rgba(58, 122, 254, .18)
    }

    .btn:hover {
      background: #2b68ea
    }

    .btn--ghost {
      background: #fff;
      color: #3a7afe;
      border: 1px solid #c8d4ff;
      box-shadow: none
    }

    .btn--ghost:hover {
      background: #f4f7ff
    }

    .chips {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      align-items: center;
      background: #fbfdff;
      border: 1px solid #eef1f5;
      border-radius: 12px;
      padding: 12px
    }

    .chip {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      background: #f3f6ff;
      border: 1px solid #dee7ff;
      color: #2845a7;
      padding: 8px 10px;
      border-radius: 999px;
      font-weight: 700;
      font-size: .92rem
    }

    .chip b {
      color: #24324d
    }

    .table-wrap {
      border: 1px solid #e9edf3;
      border-radius: 12px;
      overflow: auto;
      background: #fff;
      box-shadow: 0 2px 10px rgba(0, 0, 0, .03)
    }

    table.member-table {
      min-width: 100%;
      border-collapse: collapse;
      table-layout: fixed
    }

    .member-table th,
    .member-table td {
      border: 1px solid #e5e9f2;
      padding: 2px 2px;
      text-align: center;
      white-space: nowrap
    }

    .member-table thead th {
      position: sticky;
      top: 0;
      background: #f6f9ff;
      color: #2b3a55;
      z-index: 1;
      font-weight: 800
    }

    .member-table tbody tr:nth-child(even) td {
      background: #fafcff
    }

    .member-table tbody tr:hover td {
      background: #f0f6ff
    }

    .photo-cell img {
      width: 48px;
      height: 56px;
      object-fit: cover;
      border-radius: 6px;
      border: 1px solid #eee;
      box-shadow: 0 2px 6px rgba(0, 0, 0, .05)
    }

    .toolbar {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-top: 12px
    }

    .stat {
      color: #556;
      font-weight: 700
    }

    .pager a {
      margin: 0 6px;
      text-decoration: none;
      color: #3a7afe;
      font-weight: 800
    }

    .pager a.active {
      color: #d33;
      font-size: 1.05rem
    }

    .toolbar-right {
      display: flex;
      align-items: center;
      gap: 10px
    }

    select.page-select {
      border: 1px solid #c8d4ff;
      border-radius: 8px;
      padding: 6px 8px
    }

    .login-id {
      font-size: 14px;
      color: #555
    }


    .searchbar {
      display: flex;
      gap: 8px;
      align-items: center;
      padding: 10px;
      background: #fbfdff;
      border: 1px solid #eef1f5;
      border-radius: 12px;
    }

    .searchbar select,
    .searchbar input {
      height: 38px;
      border: 1px solid #c8d4ff;
      border-radius: 8px;
      padding: 0 10px;
    }

    .searchbar input {
      flex: 1 0 auto;
    }

    .btn--ghost.active {
      background: #3a7afe;
      color: #fff;
      border-color: #3a7afe;
    }
  </style>
</head>

<body>
  <div id="app">
    <div class="container">




      <h2 class="title">고객 목록 및 검색
        <span class="login-id" v-if="loginId">로그인 ID : {{ loginId }}</span>
        <span class="login-id" v-if="sName">로그인 성함 : {{ sName }}</span>
        <button class="btn" @click="fnUserInfoUpdate" v-if="isEmpActive">사원본인정보수정</button>
        <button class="btn" @click="fnLogout">로그아웃</button>
      </h2>

      <div class="notice">
        고객 검색 목록은 <span class="warn">프로필 공개에 동의한 회원정보만 노출</span>됩니다.
      </div>

      <!-- <div class="section">
        <div class="section__hd">선택하신 조건</div>
        <div class="chips">
          <span class="chip"><b>연령</b> {{ ageLabel }}</span>
          <span class="chip"><b>직업</b> {{ condition.job || '무관' }}</span>
          <span class="chip"><b>거주지</b> {{ condition.region || '무관' }}</span>
          <span class="chip"><b>학력</b> {{ condition.edu || '무관' }}</span>
          <span style="flex:1 0 auto"></span>
          <button class="btn btn--ghost" @click="fnGoSearchPage">다시검색</button>
        </div>
      </div> -->

      <div class="section">
        <div class="section__hd">검색
          <div style="margin-left:auto; display:flex; gap:6px;">
            <!-- <button class="btn btn--ghost" :class="{active: viewMode==='all'}" @click="setMode('all')">전체</button> -->
            <button class="btn btn--ghost" :class="{active: viewMode==='purchased'}" @click="setMode('purchased')">
              내가 정보를 구매한 타회원
            </button>
          </div>
        </div>
        <div class="searchbar">
          <select v-model="searchOption">
            <option value="all">전체</option>
            <option value="name" v-if="isEmpActive">이름</option>
            <!-- <option value="memberNo">회원번호</option> -->
            <option value="region">거주지</option>
            <option value="job">직업</option>
            <!-- <option value="gender">성별</option> -->
            <option value="birthYear">출생년</option>
          </select>

          <input type="text" v-model.trim="keyword" @keyup.enter="fnSearch" />

          <button class="btn" @click="fnSearch">검색</button>
          <button class="btn btn--ghost" @click="fnReset">초기화</button>
        </div>

        <!-- 선택된 검색 조건 칩 표시 -->
        <!-- <div class="chips" v-if="keyword">
          <span class="chip">
            <b>{{ searchOptionLabel }}</b> {{ keyword }}
          </span>
          <span style="flex:1 0 auto"></span>
          <button class="btn btn--ghost" @click="fnReset">지우기</button>
        </div> -->
      </div>



      <div class="section">
        <div class="section__hd">
          고객 목록
          <button class="btn" style="margin-left:auto" @click="fnCustAdd" v-if="isEmpActive">고객 추가</button>
        </div>

        <div class="table-wrap">
          <table class="member-table">
            <thead>
              <tr>
                <th style="width:70px">사진</th>
                <th style="width:120px">회원번호</th>
                <th style="width:120px">이름</th>
                <th style="width:100px">출생년</th>
                <th style="width:120px">키(신장)</th>
                <th style="width:180px">몸무게</th>
                <th style="width:120px">성별</th>
                <th style="width:100px" v-if="isEmpActive">수정</th>
              </tr>
            </thead>

            <tbody v-if="list.length > 0">
              <tr v-for="item in list" :key="item.MEMBER_NO" @click="onRowClick(item)" style="cursor:pointer;">
                <td class="photo-cell">
                  <!-- <img :src="item.MAIN_PHOTO_URL || defaultPhoto" :alt="item.MEMBER_NO"> -->
                  <!-- <img :src="pfx(item.MAIN_PHOTO_URL)" :alt="item.MEMBER_NO" @error="onImgError"> -->
                  <img :src="pfx(item.MAIN_PHOTO_URL)" :alt="item.MEMBER_NO" @error="onImgError"
                    @click.stop="fnPopup(pfx(item.MAIN_PHOTO_URL))" />
                </td>
                <td>{{ item.MEMBER_NO }}</td>
                <!-- <td>{{ item.NAME || '-' }}</td> -->
                <td>{{ displayName(item) }}</td>
                <td>{{ item.BIRTH_YEAR || '-' }}</td>
                <td>{{ item.HEIGHT || '-' }}</td>
                <td>{{ item.WEIGHT || '-' }}</td>
                <td>{{ item.GENDER || '-' }}</td>
                <td v-if="isEmpActive">
                  <button class="btn btn--ghost" @click.stop="fnGoEdit(item.MEMBER_NO)" v-if="canEdit(item)">수정</button>
                </td>
              </tr>
            </tbody>

            <tbody v-else>
              <tr>
                <td colspan="9">조회된 데이터가 없습니다.</td>
              </tr>
            </tbody>
          </table>
        </div>

        <div class="toolbar">
          <div class="stat">총 {{ count }}건 / {{ page }} 페이지</div>
          <div class="toolbar-right">
            <select class="page-select" v-model="pageSize" @change="fnList">
              <option value="5">5개씩</option>
              <option value="10">10개씩</option>
              <option value="15">15개씩</option>
              <option value="20">20개씩</option>
            </select>

            <div class="pager">
              <a href="javascript:;" v-if="page != 1" @click="fnMove(-1)">◀</a>
              <a class="index" href="javascript:;" v-for="num in index" :class="{active:num==page}"
                @click="fnPage(num)">
                <span v-if="num == page">{{num}}</span>
                <span v-else>{{num}}</span>
              </a>
              <a href="javascript:;" v-if="page != index" @click="fnMove(1)">▶</a>
            </div>

            <button class="btn" @click="fnLoadMore" :disabled="page>=index">+ 더보기</button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script>
    const userCode = "imp03303441"; // 결제용 가맹점코드

    const app = Vue.createApp({
      data() {
        return {
          list: [],
          count: 0,
          index: 0,
          pageSize: 5,
          page: 1,
          condition: { ageMin: null, ageMax: null, job: null, region: null, edu: null },
          defaultPhoto: "../server/uploads/nouploadimg.png",
          loginId: "",
          sStatus: "",
          sName: "", //250917 세션에 이름추가

          isEmpActive: false,
          ageLabel: "무관",     // computed 대신 문자열
          isPaying: false,      // 매우 기본적인 중복 방지
          searchOption: "all",
          keyword: "",
          // searchPlaceholder: "이름·회원번호·거주지 등으로 검색",

          viewMode: 'all',   // ★ 'all' | 'purchased'
        };
      },
      methods: {
        fnGoSearchPage() {
          alert("아직 구현 못했습니다.");
        },
        fnGoDetail(memberNo) {
          location.href = `cms_customer_view.html?memberNo=${memberNo}`;
        },

        // 리스트
        // fnList() {
        //   const param = { pageSize: this.pageSize, offset: (this.page - 1) * this.pageSize };
        //   $.ajax({
        //     url: "http://localhost:3009/cms/custlist",
        //     dataType: "json",
        //     type: "GET",
        //     data: param,
        //     success: (data) => {
        //       // alert("서버에서 받은 데이터는 " + JSON.stringify(data));
        //       this.list = data.list || data.boardList || [];
        //       this.count = data.count || 0;
        //       this.index = Math.ceil(this.count / this.pageSize) || 1;
        //     }
        //   });
        // },
        fnPage(num) {
          this.page = num;
          this.fnList();
        },
        fnMove(move) {
          this.page += move;
          this.fnList();
        },
        fnLoadMore() {
          if (this.page >= this.index) return;
          const next = this.page + 1;
          const param = {
            pageSize: this.pageSize, offset: (next - 1) * this.pageSize
            ,
            sStatus: this.sStatus, // 👇 추가
            loginId: this.loginId

          };
          $.ajax({
            url: "http://localhost:3009/cms/custlist",
            dataType: "json",
            type: "GET",
            data: param,
            success: (data) => {
              const more = data.list || data.boardList || [];
              this.list = this.list.concat(more);
              this.page = next;
            }
          });
        },

        // 세션/네비
        fnLogout() {
          sessionStorage.removeItem("sessionId");
          sessionStorage.removeItem("sessionStatus");
          alert("로그아웃 되었습니다.");
          location.href = "cms_login.html";
        },
        fnCustAdd() {
          if (this.sStatus != null) location.href = "cms_customer_add.html";
          else {
            alert("로그인 후 이용해주세요");
            location.href = "cms_login.html";
          }
        },
        fnUserInfoUpdate() {
          if (this.sStatus != null) location.href = `cms_empuser_edit.html?loginId=${this.loginId}`;
          else {
            alert("로그인 후 이용해주세요");
            location.href = "cms_login.html";
          }
        },

        // 권한
        canEdit(item) {
          const my = (this.loginId || '').trim();
          const owner = (String(item.CREATEBY || '')).trim();
          return !!my && my === owner;
        },
        fnGoEdit(memberNo) {
          location.href = `cms_customer_update.html?memberNo=${memberNo}`;
        },

        // 행 클릭: 결제 → 성공 시 상세 이동 ( 기본 콜백 방식)
        // onRowClick(item) {
        //   // alert("클릭시 item 자료는 " + JSON.stringify(item));
        //   // 1) 직원이면 바로 진입
        //   if (this.isEmpActive) {
        //     this.fnGoDetail(item.MEMBER_NO);
        //     return;
        //   }

        //   // 2) 고객이면서 본인이 만든 프로필이면(= 소유자) 무료 진입
        //   //    ※ canEdit에서 loginId와 item.CREATEBY를 비교 중
        //   if (this.canEdit(item)) {
        //     this.fnGoDetail(item.MEMBER_NO);
        //     return;
        //   }

        //   // 3) 고객이면서 타인 프로필이면 결제 후 이동
        //   if (this.isPaying) return;
        //   this.isPaying = true;
        //   this.fnPayment(item, (ok) => {
        //     this.isPaying = false;
        //     if (ok) this.fnGoDetail(item.MEMBER_NO);
        //   });
        // },
        onRowClick: function (item) {
          // 1) 직원/작성자는 바로 입장
          if (this.isEmpActive) { this.fnGoDetail(item.MEMBER_NO); return; }

          // 2) 본인이 작성한 프로필은 무료 입장
          if (this.canEdit(item)) { this.fnGoDetail(item.MEMBER_NO); return; }

          var self = this;
          var memberNo = String(item.MEMBER_NO || '').trim();

          // 3) 3일 내 열람권 있는지 먼저 확인
          this.checkAccess(memberNo, function (allowed) {
            if (allowed) {
              // 이미 구매해서 아직 유효 → 결제 없이 바로 진입
              self.fnGoDetail(memberNo);
              return;
            }

            // 4) 없으면 결제 진행
            if (self.isPaying) return;
            self.isPaying = true;

            self.fnPayment(item, function (ok, orderId) {
              self.isPaying = false;
              if (!ok) return;

              // 5) 결제 성공 → 3일 열람권 부여 후 이동
              self.grantAccess(memberNo, orderId, function (granted) {
                if (granted) {
                  self.fnGoDetail(memberNo);
                } else {
                  alert('결제는 성공했지만 열람권 발급에 실패했습니다. 관리자에게 문의해주세요.');
                }
              });
            });
          });
        },



        // 결제 (콜백: true/false)
        // fnPayment(item, done) {
        //   if (!window.IMP || !window.IMP.request_pay) {
        //     alert("결제 모듈이 로드되지 않았습니다.");
        //     done(false);
        //     return;
        //   }

        //   // >>> 여기서만 한 번만 선언 (중복 선언 금지)
        //   const memberNo = String(item.MEMBER_NO || '').trim();
        //   const buyerName = sessionStorage.getItem("sessionName"); //로그인 순간 세션에서부터 넣어버림  //String(item.NAME || this.loginId || '고객').trim();
        //   const buyerEmail = "";//String(item.EMAIL || '').trim();              // 없으면 빈 문자열
        //   const buyerTel = "";//String(item.PHONE || '010-0000-0000').trim(); // 기본값
        //   const merchantUid = `cust_${memberNo}_${Date.now()}`;

        //   window.IMP.request_pay({
        //     pg: "html5_inicis",
        //     pay_method: "card",
        //     merchant_uid: merchantUid,
        //     name: `회원(${memberNo}) 프로필 열람`,
        //     amount: 1,
        //     buyer_name: buyerName,
        //     buyer_email: buyerEmail,
        //     buyer_tel: buyerTel
        //   }, (rsp) => {
        //     if (rsp.success) {
        //       console.log("결제 성공:", rsp);
        //       alert("결제 성공");
        //       done(true);
        //     } else {
        //       alert("결제가 실패 또는 취소되었습니다.");
        //       done(false);
        //     }
        //   });
        // },
        fnPayment: function (item, done) {
          if (!window.IMP || !window.IMP.request_pay) {
            alert("결제 모듈이 로드되지 않았습니다.");
            done(false);
            return;
          }

          var memberNo = String(item.MEMBER_NO || '').trim();
          var buyerName = sessionStorage.getItem("sessionName") || '';
          var buyerEmail = "";
          var buyerTel = "";
          var merchantUid = 'cust_' + memberNo + '_' + Date.now();

          window.IMP.request_pay({
            pg: "html5_inicis",
            pay_method: "card",
            merchant_uid: merchantUid,
            name: "회원(" + memberNo + ") 프로필 열람",
            amount: 1,
            buyer_name: buyerName,
            buyer_email: buyerEmail,
            buyer_tel: buyerTel
          }, function (rsp) {
            if (rsp.success) {
              // ✅ 결제번호를 함께 전달 (열람권 발급에 사용)
              done(true, merchantUid);
            } else {
              alert("결제가 실패 또는 취소되었습니다.");
              done(false);
            }
          });
        },


        pfx(p) {
          if (!p) return this.defaultPhoto;
          p = String(p).replace(/\\/g, '/');               // \ → /
          return `/server${p.startsWith('/') ? '' : '/'}${p}`;
        },
        onImgError(e) {
          e.target.onerror = null; e.target.src = this.defaultPhoto;
        },
        fnPopup: function (url) {
          // 첫번째 파라미터 : 팝업을 띄울 주소(파일)
          // 두번째 파라미터 : 팝업의 이름 같은 이름의 팝업은 2개이상 출력되지 않는다. (계속 클릭해도)
          // 세번째 파라미터 : 크기(width, height) 및 위치(left, top)
          let top = (screen.availHeight - 400) / 2
          let left = (screen.availWidth - 400) / 2
          // console.log("위아래중간", mh);
          // console.log("좌우중간", mw);
          // src="../media/skj_img.jpg"
          window.open(url, "popup", `width=500, height=500, left=${left}, top=${top}`);
        },

        fnSearch() {
          // 새 검색은 1페이지부터
          this.page = 1;
          this.fnList();
        },
        fnReset() {
          this.searchOption = "all";
          this.keyword = "";
          this.page = 1;
          this.fnList();
        },
        // 리스트 (검색 파라미터 포함)
        fnList() {
          const param = {
            pageSize: this.pageSize,
            offset: (this.page - 1) * this.pageSize,
            option: this.searchOption,
            keyword: this.keyword,
            // 👇 추가
            sStatus: this.sStatus,
            loginId: this.loginId
          };
          $.ajax({
            url: "http://localhost:3009/cms/custlist",
            dataType: "json",
            type: "GET",
            data: param,
            success: (data) => {
              this.list = data.list || data.boardList || [];
              this.count = data.count || 0;
              this.index = Math.ceil(this.count / this.pageSize) || 1;
            }
          });
        },
        // fnList: function () {
        //   var url = "http://localhost:3009/cms/custlist";   // 기본: 전체 목록
        //   if (this.viewMode === 'purchased') {
        //     // ★ “내가 결제해서 아직 유효한 회원들” 전용 API (백엔드에서 만들어둔 조인 결과)
        //     //    응답 형태는 { list, count }를 custlist와 동일하게 맞춰두면 프론트 수정이 최소화됨
        //     url = "http://localhost:3009/cms/access/mylist";
        //   }

        //   var param = {
        //     pageSize: this.pageSize,
        //     offset: (this.page - 1) * this.pageSize,
        //     option: this.searchOption,
        //     keyword: this.keyword,
        //     sStatus: this.sStatus,
        //     loginId: this.loginId          // ★ viewerId 로 백엔드에서 사용
        //   };

        //   $.ajax({
        //     url: url,
        //     dataType: "json",
        //     type: "GET",
        //     data: param,
        //     success: (data) => {
        //       this.list = data.list || [];
        //       this.count = data.count || 0;
        //       this.index = Math.ceil(this.count / this.pageSize) || 1;
        //     }
        //   });
        // },

        displayName(item) {
          // 직원이면 이름 그대로 노출
          if (this.isEmpActive) return item.NAME || '-';

          // 고객이면: 본인이 작성한 프로필만 이름 노출, 그 외는 비공개
          const my = (this.loginId || '').trim();
          const owner = (String(item.CREATEBY || '')).trim();
          if (my && my === owner) return item.NAME || '-';

          // 다른 고객의 이름은 숨김
          return '비공개';
        },

        // (A) 열람권 보유 여부 확인: allowed(true/false)를 콜백으로 돌려줌
        checkAccess: function (memberNo, cb) {
          $.ajax({
            url: 'http://localhost:3009/cms/access/check',
            type: 'GET', dataType: 'json',
            data: { viewerId: this.loginId, memberNo: memberNo },
            success: function (res) { cb(!!(res && res.allowed)); },
            error: function () { cb(false); }
          });
        },

        // (B) 열람권 발급/연장: 성공 여부를 콜백으로 돌려줌
        grantAccess: function (memberNo, orderId, cb) {
          $.ajax({
            url: 'http://localhost:3009/cms/access/grant',
            type: 'GET', dataType: 'json',
            data: { viewerId: this.loginId, memberNo: memberNo, orderId: orderId, amount: 1, days: 3 },
            success: function (res) { cb(!!(res && res.ok)); },
            error: function () { cb(false); }
          });
        },


        setMode: function (mode) {
          this.viewMode = mode;
          this.page = 1;            // 첫 페이지부터
          this.fnList();            // 목록 다시 로드
        },

      },
      mounted() {
        // 세션
        self = this;
        const sId = sessionStorage.getItem("sessionId");
        const sStatus = sessionStorage.getItem("sessionStatus");
        let sName = sessionStorage.getItem("sessionName");

        self.loginId = sId || "";
        self.sStatus = sStatus || "";
        self.sName = sName || "";

        if (!this.loginId) {
          alert("로그인이 필요합니다.");
          location.href = "cms_login.html";
          return;
        }
        this.isEmpActive = (this.sStatus === 'active');

        // 아주 단순한 ageLabel 계산(초기 한 번)
        // const { ageMin, ageMax } = this.condition || {};
        // if (ageMin && ageMax) this.ageLabel = ageMin + "~" + ageMax;
        // else if (ageMin && !ageMax) this.ageLabel = ageMin + "+";
        // else if (!ageMin && ageMax) this.ageLabel = "~" + ageMax;
        // else this.ageLabel = "무관";

        // 아임포트 초기화
        if (window.IMP && window.IMP.init) {
          window.IMP.init(userCode);
        }

        self.fnList();
      }
    });

    app.mount('#app');
  </script>
</body>

</html>