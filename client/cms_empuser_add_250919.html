<!DOCTYPE html>
<html lang="ko">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1.0" />
  <title>시스템 사용자 추가</title>
  <script src="https://code.jquery.com/jquery-3.7.1.js" crossorigin="anonymous"></script>
  <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>

  <style>
    /* ===== Layout / Theme (통일) ===== */
    body {
      margin: 0;
      background: #f5f6f8;
      font-family: Arial, sans-serif;
      color: #222
    }

    #app {
      display: flex;
      justify-content: center;
      align-items: flex-start;
      min-height: 100vh;
      padding: 24px 12px;
      box-sizing: border-box
    }

    .container {
      width: 980px;
      max-width: 100%;
      background: #fff;
      border-radius: 14px;
      padding: 20px;
      border: 1px solid #eef2f7;
      box-shadow: 0 8px 22px rgba(0, 0, 0, .08)
    }

    .title {
      margin: 0 0 12px;
      text-align: center;
      font-size: 1.35rem;
      font-weight: 800;
      color: #223
    }

    /* 안내 */
    .notice {
      background: #f8fbff;
      border: 1px solid #e6f0ff;
      color: #334;
      padding: 12px 14px;
      border-radius: 10px;
      line-height: 1.6;
      margin-bottom: 10px
    }

    .warn {
      color: #c62828;
      font-weight: 800
    }

    /* 섹션 헤더 */
    .section {
      margin-top: 14px
    }

    .section__hd {
      margin: 0 0 10px;
      padding-bottom: 6px;
      font-size: 1.02rem;
      font-weight: 800;
      color: #2b3a55;
      border-bottom: 2px solid #e8eefc
    }

    /* 메시지 박스 */
    .msg {
      margin: 10px 0;
      padding: 10px 12px;
      border: 1px solid #dde4f2;
      border-radius: 10px
    }

    .msg.ok {
      background: #f1fff4;
      border-color: #8bc48b;
      color: #256b2c
    }

    .msg.err {
      background: #fff3f3;
      border-color: #e58a8a;
      color: #8a2626
    }

    /* 버튼 */
    .btn {
      display: inline-block;
      padding: 10px 14px;
      border-radius: 10px;
      border: none;
      cursor: pointer;
      font-weight: 800;
      background: #3a7afe;
      color: #fff;
      box-shadow: 0 4px 10px rgba(58, 122, 254, .18)
    }

    .btn:hover {
      background: #2b68ea
    }

    .btn--ghost {
      background: #fff;
      color: #3a7afe;
      border: 1px solid #c8d4ff;
      box-shadow: none
    }

    .btn--ghost:hover {
      background: #f4f7ff
    }

    .btn-row {
      text-align: center;
      margin-top: 16px
    }

    .btn-row .btn {
      margin: 0 4px
    }

    /* 입력 공통 */
    .field {
      width: 100%;
      box-sizing: border-box;
      border: 1px solid #e5e9f2;
      background: #fbfdff;
      border-radius: 10px;
      padding: 10px 12px;
      font-size: .95rem
    }

    .field:focus {
      outline: none;
      border-color: #9bb5ff;
      box-shadow: 0 0 0 3px rgba(58, 122, 254, .15)
    }

    .select {
      appearance: none;
      background-image: linear-gradient(45deg, transparent 50%, #3a7afe 50%), linear-gradient(135deg, #3a7afe 50%, transparent 50%);
      background-position: calc(100% - 18px) calc(1em + 2px), calc(100% - 12px) calc(1em + 2px);
      background-size: 6px 6px, 6px 6px;
      background-repeat: no-repeat
    }

    .help {
      color: #556;
      font-size: .85rem;
      margin-top: 6px
    }

    /* 라벨 칩 */
    .label-chip {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      font-weight: 800;
      color: #24324d;
      background: #f3f6ff;
      border: 1px solid #dee7ff;
      border-radius: 999px;
      padding: 6px 10px
    }

    .req-dot {
      display: inline-block;
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background: #d93636
    }

    /* 테이블 폼 */
    .table-wrap {
      border: 1px solid #e9edf3;
      border-radius: 12px;
      overflow: hidden;
      background: #fff;
      box-shadow: 0 2px 10px rgba(0, 0, 0, .03)
    }

    table.table-form {
      width: 100%;
      border-collapse: separate;
      border-spacing: 0
    }

    .table-form th,
    .table-form td {
      padding: 12px;
      vertical-align: middle
    }

    .table-form tbody tr+tr td,
    .table-form tbody tr+tr th {
      border-top: 1px solid #eef2f7
    }

    .table-form th {
      background: #f7f9ff;
      width: 180px;
      text-align: left;
      color: #415172;
      font-weight: 800;
      border-right: 1px solid #eef2f7
    }

    .table-form td {
      background: #fff
    }

    .inline {
      display: flex;
      align-items: center;
      gap: 8px
    }

    .inline label {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      color: #445;
      font-size: .92rem
    }

    /* 중복체크 결과 뱃지 */
    .badge {
      display: inline-block;
      padding: 6px 10px;
      border-radius: 999px;
      font-size: .82rem;
      font-weight: 800
    }

    .badge.ok {
      background: #e9fff0;
      color: #1e7a38;
      border: 1px solid #9dd8a9
    }

    .badge.err {
      background: #fff0f0;
      color: #b23b3b;
      border: 1px solid #f0b6b6
    }

    @media (max-width:700px) {
      .table-form th {
        width: 120px
      }
    }
  </style>
</head>

<body>
  <div id="app" v-cloak>
    <div class="container">
      <h2 class="title">시스템 사용자 추가</h2>

      <div class="notice">
        시스템 사용자(결혼,소개 고객정보 회사 사원) 정보를 등록합니다. <span class="warn">필수 항목</span>을 정확히 입력해 주세요.
      </div>

      <div v-if="msg" class="msg" :class="{ 'ok': msgType==='ok', 'err': msgType==='err' }">{{ msg }}</div>

      <div class="section">
        <div class="section__hd">기본 정보</div>
        <div class="table-wrap">
          <table class="table-form">
            <colgroup>
              <col style="width:180px">
              <col>
              <col style="width:180px">
              <col>
            </colgroup>
            <tbody>
              <tr>
                <th><span class="label-chip"><span class="req-dot"></span>사원 이름</span></th>
                <td>
                  <input type="text" class="field" v-model.trim="form.name" placeholder="홍길동">
                </td>

                <th><span class="label-chip"><span class="req-dot"></span> 아이디(로그인)</span></th>
                <td class="inline">
                  <!-- 학생 예시처럼 중복체크 성공 후 비활성 처리 -->
                  <template v-if="checkFlg">
                    <input type="text" class="field" v-model.trim="form.loginId" placeholder="manager01" disabled>
                  </template>
                  <template v-else>
                    <input type="text" class="field" v-model.trim="form.loginId" placeholder="manager01">
                  </template>

                  <button class="btn" @click="fnCheck" :disabled="checking">중복체크</button>
                  <span v-if="checkResult==='ok'" class="badge ok">사용 가능</span>
                  <span v-if="checkResult==='dup'" class="badge err">이미 사용중</span>
                </td>
              </tr>

              <tr>
                <th><span class="label-chip"><span class="req-dot"></span> 비밀번호</span></th>
                <td>
                  <input :type="showPw ? 'text':'password'" class="field" v-model="form.password"
                    placeholder="영문/숫자 8자 이상">
                  <div class="help">{{ pwHelp }}</div>
                </td>

                <th><span class="label-chip"><span class="req-dot"></span> 비밀번호 확인</span></th>
                <td class="inline">
                  <input :type="showPw ? 'text':'password'" class="field" v-model="confirmPw" placeholder="비밀번호 재입력"
                    style="flex:1;">
                  <label><input type="checkbox" v-model="showPw"> 보기</label>
                </td>
              </tr>

              <tr>
                <th><span class="label-chip"><span class="req-dot"></span> 이메일</span></th>
                <td><input type="text" class="field" v-model.trim="form.email" placeholder="name@company.com"></td>
                <th><span class="label-chip"><span class="req-dot"></span> 휴대폰</span></th>
                <td><input type="text" class="field" v-model.trim="form.phone" placeholder="010-0000-0000"></td>
              </tr>

              <tr>
                <th>입사일</th>
                <td><input type="date" class="field" v-model="form.hiredAt"></td>
                <th>상태</th>
                <td>
                  <select class="field select" v-model="form.status">
                    <option value="active">재직</option>
                    <option value="inactive">휴직</option>
                    <option value="left">퇴사</option>
                  </select>
                </td>
              </tr>

              <tr>
                <th>비고 메모</th>
                <td colspan="3">
                  <textarea class="field" v-model="form.note" placeholder="추가하실 내용 있으면 추가하세요"
                    style="height:90px;"></textarea>
                </td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>

      <div class="btn-row">
        <button class="btn" @click="fnSave">저장</button>
        <button class="btn btn--ghost" @click="fnReset">초기화</button>
        <button class="btn btn--ghost">
          <a href="cms_login.html" style="text-decoration:none; color:inherit;">로그인 화면으로</a>
        </button>
      </div>
    </div>
  </div>

  <script>
    const app = Vue.createApp({
      data() {
        return {
          showPw: false,
          confirmPw: "",
          msg: "",
          msgType: "", // 'ok' | 'err'
          checkFlg: false,       // ✅ 중복체크 통과 여부
          checkResult: "",      // '', 'ok', 'dup'
          checking: false,       // AJAX 중복 요청 방지
          form: {
            name: "",
            loginId: "",
            password: "",
            email: "",
            phone: "",
            branch: "",
            role: "",
            hiredAt: new Date().toISOString().slice(0, 10),
            status: "active",
            note: "",
            permissions: { customerWrite: true, customerEdit: true, customerDelete: false }
          }
        }
      },
      computed: {
        pwHelp() {
          const p = this.form.password || "";
          const ok = p.length >= 8 && /[A-Za-z]/.test(p) && /\d/.test(p);
          return ok ? "안전한 비밀번호입니다." : "8자 이상 & 숫자/문자 조합 권장";
        }
      },
      methods: {
        // ✅ 아이디 중복체크 (학생 예시와 동일한 UX: 성공 시 입력 비활성화)
        fnCheck() {
          let self = this;
          if (self.checking) return;
          let id = (self.form.loginId || '').trim();
          if (!id) { alert('아이디를 입력하세요.'); return; }
          if (id.length < 4) { alert('아이디는 4자 이상으로 입력하세요.'); return; }

          self.checking = true; self.checkResult = ''; self.checkFlg = false;
          $.ajax({
            url: 'http://localhost:3009/cms/useridsearch',
            dataType: 'json',
            type: 'GET',
            data: { loginId: id },
            success: function (data) {
              // 다양한 응답 형태를 방어적으로 처리
              // 1) { exists: true|false }
              // 2) [] or [{...}] (길이 0이면 미존재)
              let exists = false;
              if (data && typeof data.exists === 'boolean') exists = data.exists;
              else if (Array.isArray(data)) exists = data.length > 0;

              if (!exists) {
                alert('사용가능한 아이디입니다.');
                self.checkFlg = true;
                self.checkResult = 'ok';
              } else {
                alert('이미 사용중인 아이디입니다.');
                self.checkFlg = false;
                self.checkResult = 'dup';
              }
            },
            error: function (xhr) {
              console.error(xhr && xhr.responseText ? xhr.responseText : xhr);
              alert('중복체크 중 오류가 발생했습니다.');
            },
            complete: function () { self.checking = false; }
          });
        },

        fnValidate() {
          if (!this.form.name) return '이름을 입력하세요.';
          if (!this.form.loginId) return '아이디를 입력하세요.';
          if (!this.checkFlg) return '아이디 중복체크를 완료하세요.'; // ✅ 중복체크 강제
          if (!this.form.password) return '비밀번호를 입력하세요.';
          if (this.form.password.length < 8 || !(/[A-Za-z]/.test(this.form.password) && /\d/.test(this.form.password)))
            return '비밀번호는 8자 이상, 숫자/문자 혼합을 권장합니다.';
          if (!this.confirmPw || this.confirmPw !== this.form.password) return '비밀번호 확인이 일치하지 않습니다.';
          if (!this.form.email || !/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(this.form.email)) return '이메일 형식이 올바르지 않습니다.';
          if (!this.form.phone || !/^\d{2,3}-\d{3,4}-\d{4}$/.test(this.form.phone)) return '휴대폰 형식이 올바르지 않습니다. 예) 010-1234-5678';
          return '';
        },

        fnSave() {
          let self = this;
          const err = self.fnValidate();
          if (err) { self.msg = err; self.msgType = 'err'; return; }
          self.msg = ''; self.msgType = '';

          // 학원식: param 객체로 쿼리스트링 전송
          let param = {
            name: self.form.name,
            loginId: self.form.loginId,
            password: self.form.password,
            email: self.form.email,
            phone: self.form.phone,
            hiredAt: self.form.hiredAt,
            status: self.form.status,
            note: self.form.note
          };

          $.ajax({
            url: 'http://localhost:3009/cms/userinsert', // GET 엔드포인트에 맞게 수정
            type: 'GET',
            dataType: 'json',
            data: param,
            success: function () {
              self.msg = '사용자가 저장되었습니다.';
              self.msgType = 'ok';
              alert('사용자가 저장되었습니다.\n\n[확인]을 누르면 로그인 화면으로 이동합니다.');
              location.href = 'cms_login.html';
            },

          });
        },


        fnReset() {
          this.msg = ''; this.msgType = ''; this.confirmPw = '';
          this.checkFlg = false; this.checkResult = '';
          this.form = {
            name: '', loginId: '', password: '', email: '', phone: '',
            branch: '', role: '', hiredAt: new Date().toISOString().slice(0, 10),
            status: 'active', note: '', permissions: { customerWrite: true, customerEdit: true, customerDelete: false }
          };
        },

        fnGoList() {
          location.href = 'user_list.html';
        }
      }, //메소드 끝

      mounted() {
        // 처음 시작할 때 실행되는 부분
      }


    });

    app.mount('#app');
  </script>
</body>

</html>