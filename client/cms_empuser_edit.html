<!DOCTYPE html>
<html lang="ko">

<head>
  <meta charset="UTF-8">
  <title>사원 사용자 수정</title>
  <script src="https://code.jquery.com/jquery-3.7.1.js" crossorigin="anonymous"></script>
  <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
  <style>
    body {
      font-family: Arial, sans-serif;
      background: #f5f6f8;
      margin: 0
    }

    .wrap {
      max-width: 720px;
      margin: 32px auto;
      background: #fff;
      padding: 20px;
      border-radius: 12px;
      box-shadow: 0 6px 16px rgba(0, 0, 0, .08)
    }

    h2 {
      margin: 0 0 16px
    }

    .row {
      display: flex;
      gap: 12px;
      margin-bottom: 12px
    }

    .row label {
      width: 140px;
      font-weight: 700
    }

    .row input,
    .row select,
    .row textarea {
      flex: 1;
      padding: 10px;
      border: 1px solid #e5e9f2;
      border-radius: 8px;
      background: #fbfdff
    }

    .btns {
      margin-top: 16px;
      text-align: right
    }

    .btn {
      padding: 10px 14px;
      border: none;
      border-radius: 10px;
      font-weight: 800;
      cursor: pointer
    }

    .btn.primary {
      background: #3a7afe;
      color: #fff
    }

    .btn.ghost {
      background: #fff;
      border: 1px solid #c8d4ff;
      color: #3a7afe
    }
  </style>
</head>

<body>
  <div id="app" class="wrap" v-cloak>
    <h2>사원 사용자 수정</h2>

    <div class="row"><label>아이디(로그인)</label><input v-model="form.loginId" disabled></div>
    <div class="row"><label>이름</label><input v-model="form.name" placeholder="이름"></div>
    <div class="row"><label>이메일</label><input v-model="form.email" placeholder="name@company.com"></div>
    <div class="row"><label>휴대폰</label><input v-model="form.phone" placeholder="010-0000-0000"></div>
    <div class="row"><label>상태</label>
      <select v-model="form.status">
        <option value="active">재직</option>
        <option value="inactive">휴직</option>
        <option value="left">퇴사</option>
      </select>
    </div>
    <div class="row"><label>입사일</label><input type="date" v-model="form.hiredAt"></div>
    <div class="row"><label>비고</label><textarea v-model="form.note" rows="4" placeholder="메모"></textarea></div>

    <div class="btns">
      <button class="btn ghost" @click="goView">취소</button>
      <button class="btn primary" @click="fnSave">저장</button>
    </div>
  </div>

  <script>
    const app = Vue.createApp({
      data() {
        return {
          loginId: '',
          form: { loginId: '', name: '', email: '', phone: '', status: 'active', hiredAt: '', note: '' }
        }
      },
      methods: {
        // 상세 불러오기
        fnLoad() {
          const self = this;
          $.ajax({
            url: 'http://localhost:3009/cms/useridsearch',
            type: 'GET', dataType: 'json',
            data: { loginId: self.loginId },
            success(res) {
              // /cms/useridsearch 는 배열로 내려오므로 맵핑
              if (Array.isArray(res) && res.length) {
                const r = res[0];
                // 컬럼명은 오라클 대문자 기준 가정
                self.form.loginId = r.LOGIN_ID || self.loginId;
                self.form.name = r.NAME || '';
                self.form.email = r.EMAIL || '';
                self.form.phone = r.PHONE || '';
                self.form.status = r.STATUS || 'active';
                // HIRED_AT 이 DATE면 문자열 포맷은 서버 응답 형식에 맞춰 가공 필요
                self.form.hiredAt = (r.HIRED_AT && String(r.HIRED_AT).slice(0, 10)) || '';
                self.form.note = r.NOTE || '';
              } else {
                alert('사용자 정보를 찾을 수 없습니다.');
              }
            },
            error(xhr) { console.error(xhr?.responseText || xhr); alert('조회 중 오류가 발생했습니다.'); }
          });
        },

        // 저장 (학원식 GET + 쿼리파라미터)
        fnSave() {
          const self = this;
          if (!self.form.name) { alert('이름을 입력하세요.'); return; }
          if (!self.form.loginId) { alert('아이디가 없습니다.'); return; }

          const param = {
            userId: self.form.loginId,        // 서버의 /cms/userupdate가 userId 파라미터를 받도록 구성
            name: self.form.name,
            email: self.form.email,
            phone: self.form.phone,
            // 필요시 status/hiredAt/note도 함께 전송하도록 서버 업데이트 쿼리 확장 가능
            status: self.form.status,
            hiredAt: self.form.hiredAt,
            note: self.form.note
          };

          $.ajax({
            url: 'http://localhost:3009/cms/userupdate',
            type: 'GET', dataType: 'json', data: param,
            success() {
              // ✅ 학원식: 알럿 → 확인 누르면 이동
              alert('사용자 정보가 저장되었습니다.\n\n[확인]을 누르면 고객리스트로 이동합니다.');
              self.goView();
            }
          });
        },

        // 상세보기로 돌아가기 (원하면 로그인 화면/리스트로 변경)
        goView() {
          location.href = `cms_customer_list.html`;
          // 혹은: location.href = 'cms_login.html';
          // 혹은: location.href = 'cms_empuser_list.html';
        }
      },
      mounted() {
        let sId = sessionStorage.getItem("sessionId"); //서버에서 set할때 이름이 sessionID이었음 그걸 get으로 꺼냄
        let sStatus = sessionStorage.getItem("sessionStatus");

        self.loginId = sId || "";
        self.sStatus = sStatus || "";

        // 로그인 안 한 상태면 접근 차단하고 로그인 페이지로 보냄
        if (!self.loginId) {
          alert("로그인이 필요합니다.");
          location.href = "cms_login.html"; // 실제 로그인 페이지 경로로 변경
        }

        const q = new URLSearchParams(location.search);
        this.loginId = q.get('loginId') || '';
        if (!this.loginId) { alert('loginId 파라미터가 없습니다.'); return; }
        this.fnLoad();
      }
    });
    app.mount('#app');
  </script>
</body>

</html>