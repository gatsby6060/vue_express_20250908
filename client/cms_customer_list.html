<!DOCTYPE html>
<html lang="ko">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width,initial-scale=1.0">
  <title>ê³ ê° ëª©ë¡ ë° ê²€ìƒ‰</title>
  <script src="https://code.jquery.com/jquery-3.7.1.js" crossorigin="anonymous"></script>
  <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
  <script src="https://cdn.iamport.kr/v1/iamport.js"></script> <!-- ê²°ì œìš© -->

  <!-- <script src="https://oapi.map.naver.com/openapi/v3/maps.js?ncpClientId=YOUR_CLIENT_ID"></script> -->
  <script type="text/javascript" src="https://oapi.map.naver.com/openapi/v3/maps.js?ncpKeyId=jquy82alxa"></script>

  <style>
    /* ===== ê¸°ì¡´ ë””ìì¸ ê·¸ëŒ€ë¡œ ===== */
    body {
      margin: 0;
      background: #f5f6f8;
      font-family: Arial, sans-serif;
      color: #222
    }

    #app {
      display: flex;
      justify-content: center;
      align-items: flex-start;
      min-height: 100vh;
      padding: 24px 12px;
      box-sizing: border-box
    }

    .container {
      width: 1100px;
      max-width: 100%;
      background: #fff;
      border-radius: 14px;
      padding: 18px;
      box-shadow: 0 8px 22px rgba(0, 0, 0, .08);
      border: 1px solid #eef2f7
    }

    .title {
      margin: 0 0 12px;
      text-align: center;
      font-size: 1.35rem;
      font-weight: 800;
      color: #223;
      display: flex;
      justify-content: space-between
    }

    .notice {
      background: #f8fbff;
      border: 1px solid #e6f0ff;
      color: #334;
      padding: 12px 14px;
      border-radius: 10px;
      line-height: 1.6
    }

    .warn {
      color: #c62828;
      font-weight: 800
    }

    .section {
      margin-top: 16px
    }

    .section__hd {
      margin: 0 0 10px;
      padding-bottom: 6px;
      font-size: 1.02rem;
      font-weight: 800;
      color: #2b3a55;
      border-bottom: 2px solid #e8eefc;
      display: flex;
      align-items: center
    }

    .btn {
      display: inline-block;
      padding: 10px 14px;
      border-radius: 10px;
      border: none;
      cursor: pointer;
      font-weight: 800;
      background: #3a7afe;
      color: #fff;
      box-shadow: 0 4px 10px rgba(58, 122, 254, .18)
    }

    .btn:hover {
      background: #2b68ea
    }

    .btn--ghost {
      background: #fff;
      color: #3a7afe;
      border: 1px solid #c8d4ff;
      box-shadow: none
    }

    .btn--ghost:hover {
      background: #f4f7ff
    }

    .chips {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      align-items: center;
      background: #fbfdff;
      border: 1px solid #eef1f5;
      border-radius: 12px;
      padding: 12px
    }

    .chip {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      background: #f3f6ff;
      border: 1px solid #dee7ff;
      color: #2845a7;
      padding: 8px 10px;
      border-radius: 999px;
      font-weight: 700;
      font-size: .92rem
    }

    .chip b {
      color: #24324d
    }

    .table-wrap {
      border: 1px solid #e9edf3;
      border-radius: 12px;
      overflow: auto;
      background: #fff;
      box-shadow: 0 2px 10px rgba(0, 0, 0, .03)
    }

    table.member-table {
      min-width: 100%;
      border-collapse: collapse;
      table-layout: fixed
    }

    .member-table th,
    .member-table td {
      border: 1px solid #e5e9f2;
      padding: 2px 2px;
      text-align: center;
      white-space: nowrap
    }

    .member-table thead th {
      position: sticky;
      top: 0;
      background: #f6f9ff;
      color: #2b3a55;
      z-index: 1;
      font-weight: 800
    }

    .member-table tbody tr:nth-child(even) td {
      background: #fafcff
    }

    .member-table tbody tr:hover td {
      background: #f0f6ff
    }

    .photo-cell img {
      width: 48px;
      height: 56px;
      object-fit: cover;
      border-radius: 6px;
      border: 1px solid #eee;
      box-shadow: 0 2px 6px rgba(0, 0, 0, .05)
    }

    .toolbar {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-top: 12px
    }

    .stat {
      color: #556;
      font-weight: 700
    }

    .pager a {
      margin: 0 6px;
      text-decoration: none;
      color: #3a7afe;
      font-weight: 800
    }

    .pager a.active {
      color: #d33;
      font-size: 1.05rem
    }

    .toolbar-right {
      display: flex;
      align-items: center;
      gap: 10px
    }

    select.page-select {
      border: 1px solid #c8d4ff;
      border-radius: 8px;
      padding: 6px 8px
    }

    .login-id {
      font-size: 14px;
      color: #555
    }


    .searchbar {
      display: flex;
      gap: 8px;
      align-items: center;
      padding: 10px;
      background: #fbfdff;
      border: 1px solid #eef1f5;
      border-radius: 12px;
    }

    .searchbar select,
    .searchbar input {
      height: 38px;
      border: 1px solid #c8d4ff;
      border-radius: 8px;
      padding: 0 10px;
    }

    .searchbar input {
      flex: 1 0 auto;
    }

    .btn--ghost.active {
      background: #3a7afe;
      color: #fff;
      border-color: #3a7afe;
    }


    .btn--ghost.active {
      background: #e41a6e;
      color: #fff;
      border-color: #3a7afe;
    }
  </style>
</head>

<body>
  <div id="app">
    <div class="container">




      <h2 class="title">ê³ ê° ëª©ë¡ ë° ê²€ìƒ‰
        <span class="login-id" v-if="loginId">ë¡œê·¸ì¸ ID : {{ loginId }}</span>
        <span class="login-id" v-if="sName">ë¡œê·¸ì¸ ì„±í•¨ : {{ sName }}</span>
        <button class="btn" @click="fnUserInfoUpdate" v-if="isEmpActive">ì‚¬ì›ë³¸ì¸ì •ë³´ìˆ˜ì •</button>
        <button class="btn" @click="fnLogout">ë¡œê·¸ì•„ì›ƒ</button>
      </h2>

      <div class="notice">
        ê³ ê° ê²€ìƒ‰ ëª©ë¡ì€ <span class="warn">í”„ë¡œí•„ ê³µê°œì— ë™ì˜í•œ íšŒì›ì •ë³´ë§Œ ë…¸ì¶œ</span>ë©ë‹ˆë‹¤.
      </div>

      <!-- <div class="section">
        <div class="section__hd">ì„ íƒí•˜ì‹  ì¡°ê±´</div>
        <div class="chips">
          <span class="chip"><b>ì—°ë ¹</b> {{ ageLabel }}</span>
          <span class="chip"><b>ì§ì—…</b> {{ condition.job || 'ë¬´ê´€' }}</span>
          <span class="chip"><b>ê±°ì£¼ì§€</b> {{ condition.region || 'ë¬´ê´€' }}</span>
          <span class="chip"><b>í•™ë ¥</b> {{ condition.edu || 'ë¬´ê´€' }}</span>
          <span style="flex:1 0 auto"></span>
          <button class="btn btn--ghost" @click="fnGoSearchPage">ë‹¤ì‹œê²€ìƒ‰</button>
        </div>
      </div> -->

      <div class="section">
        <div class="section__hd">ê²€ìƒ‰
          <div style="margin-left:auto; display:flex; gap:6px;">
            <button class="btn btn--ghost" v-if="!isEmpActive" @click="fnGoPurchased">
              ë‚´ê°€ ì •ë³´ë¥¼ êµ¬ë§¤í•œ íƒ€íšŒì›
            </button>
            <!-- â–¼ ì¥ë°”êµ¬ë‹ˆ ë³´ê¸° -->
            <button class="btn btn--ghost" v-if="!isEmpActive" @click="goCartPage">
              ì¥ë°”êµ¬ë‹ˆ
            </button>
          </div>
        </div>
        <div class="searchbar">
          <select v-model="searchOption">
            <option value="all">ì „ì²´</option>
            <option value="name" v-if="isEmpActive">ì´ë¦„</option>
            <!-- <option value="memberNo">íšŒì›ë²ˆí˜¸</option> -->
            <option value="region">ê±°ì£¼ì§€</option>
            <option value="job">ì§ì—…</option>
            <!-- <option value="gender">ì„±ë³„</option> -->
            <option value="birthYear">ì¶œìƒë…„</option>
            <option value="gender">ì„±ë³„</option>
          </select>

          <!-- ì„±ë³„ì´ ì•„ë‹ ë•ŒëŠ” í…ìŠ¤íŠ¸ ì¸í’‹ -->
          <input v-if="searchOption !== 'gender'" type="text" v-model.trim="keyword" @keyup.enter="fnSearch" />
          <!-- ì„±ë³„ì¼ ë•ŒëŠ” ë“œë¡­ë‹¤ìš´ -->
          <select v-else v-model="gender">
            <option value="">ì „ì²´</option>
            <option value="M">ë‚¨ì</option>
            <option value="F">ì—¬ì</option>
            <option value="N">ê¸°íƒ€/ë¯¸ìƒ</option>
          </select>

          <button class="btn" @click="fnSearch">ê²€ìƒ‰</button>
          <button class="btn btn--ghost" @click="fnReset">ì´ˆê¸°í™”</button>
        </div>

        <!-- ì„ íƒëœ ê²€ìƒ‰ ì¡°ê±´ ì¹© í‘œì‹œ -->
        <!-- <div class="chips" v-if="keyword">
          <span class="chip">
            <b>{{ searchOptionLabel }}</b> {{ keyword }}
          </span>
          <span style="flex:1 0 auto"></span>
          <button class="btn btn--ghost" @click="fnReset">ì§€ìš°ê¸°</button>
        </div> -->
      </div>



      <div class="section">
        <div class="section__hd">
          ê³ ê° ëª©ë¡
          <button class="btn" style="margin-left:auto" @click="fnCustAdd" v-if="isEmpActive">ê³ ê° ì¶”ê°€</button>
        </div>

        <div class="table-wrap">
          <table class="member-table">
            <thead>
              <tr>
                <th style="width:70px">ì‚¬ì§„</th>
                <th style="width:120px">íšŒì›ë²ˆí˜¸</th>
                <th style="width:120px">ì´ë¦„</th>
                <th style="width:100px">ì¶œìƒë…„</th>
                <th style="width:120px">í‚¤(ì‹ ì¥)</th>
                <th style="width:180px">ëª¸ë¬´ê²Œ</th>
                <th style="width:120px">ì„±ë³„</th>
                <th style="width:100px" v-if="isEmpActive">ìˆ˜ì •</th>
                <th style="width:120px" v-if="!isEmpActive">ì¥ë°”êµ¬ë‹ˆ</th>
              </tr>
            </thead>

            <tbody v-if="list.length > 0">
              <tr v-for="item in list" :key="item.MEMBER_NO" @click="onRowClick(item)" style="cursor:pointer;">
                <td class="photo-cell">
                  <!-- <img :src="item.MAIN_PHOTO_URL || defaultPhoto" :alt="item.MEMBER_NO"> -->
                  <!-- <img :src="pfx(item.MAIN_PHOTO_URL)" :alt="item.MEMBER_NO" @error="onImgError"> -->
                  <img :src="pfx(item.MAIN_PHOTO_URL)" :alt="item.MEMBER_NO" @error="onImgError"
                    @click.stop="fnPopup(pfx(item.MAIN_PHOTO_URL))" />
                </td>
                <td>{{ item.MEMBER_NO }}</td>
                <!-- <td>{{ item.NAME || '-' }}</td> -->
                <td>{{ displayName(item) }}</td>
                <td>{{ item.BIRTH_YEAR || '-' }}</td>
                <td>{{ item.HEIGHT || '-' }}</td>
                <td>{{ item.WEIGHT || '-' }}</td>
                <td>{{ item.GENDER || '-' }}</td>
                <td v-if="isEmpActive">
                  <button class="btn btn--ghost" @click.stop="fnGoEdit(item.MEMBER_NO)" v-if="canEdit(item)">ìˆ˜ì •</button>
                </td>
                <!-- â–¼ ê³ ê° ì „ìš©: ì¥ë°”êµ¬ë‹ˆ ë²„íŠ¼ -->
                <td v-if="!isEmpActive">
                  <button class="btn btn--ghost" :class="{ active: isInCart(item.MEMBER_NO) }"
                    :disabled="cartBusy[item.MEMBER_NO]" @click.stop="toggleCart(item)">
                    <span v-if="isInCart(item.MEMBER_NO)">â˜… ë‹´ê¹€</span>
                    <span v-else>â˜† ë‹´ê¸°</span>
                  </button>
                </td>
              </tr>
            </tbody>

            <tbody v-else>
              <tr>
                <td colspan="9">ì¡°íšŒëœ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.</td>
              </tr>
            </tbody>
          </table>
        </div>

        <div class="toolbar">
          <div class="stat">ì´ {{ count }}ê±´ / {{ page }} í˜ì´ì§€</div>
          <div class="toolbar-right">
            <select class="page-select" v-model="pageSize" @change="fnList">
              <option value="5">5ê°œì”©</option>
              <option value="10">10ê°œì”©</option>
              <option value="15">15ê°œì”©</option>
              <option value="20">20ê°œì”©</option>
            </select>

            <div class="pager">
              <a href="javascript:;" v-if="page != 1" @click="fnMove(-1)">â—€</a>
              <a class="index" href="javascript:;" v-for="num in index" :class="{active:num==page}"
                @click="fnPage(num)">
                <span v-if="num == page">{{num}}</span>
                <span v-else>{{num}}</span>
              </a>
              <a href="javascript:;" v-if="page != index" @click="fnMove(1)">â–¶</a>
            </div>

            <button class="btn" @click="fnLoadMore" :disabled="page>=index">+ ë”ë³´ê¸°</button>
          </div>
        </div>
      </div>


      <!-- admin ë˜ëŠ” ì§ì›ì¼ ë•Œë§Œ ë³´ì„ -->
      <div class="section" v-if="isAdmin || isEmpActive">
        <div class="section__hd">ê³ ê° ìœ„ì¹˜ ì§€ë„</div>
        <div id="adminMap" style="height:420px;border:1px solid #e9edf3;border-radius:12px;"></div>
      </div>


    </div><!--ì»¨í…Œì´ë„ˆë-->
  </div><!--ì•±ë-->

  <script>
    const userCode = "imp03303441"; // ê²°ì œìš© ê°€ë§¹ì ì½”ë“œ

    const app = Vue.createApp({
      data() {
        return {
          list: [],
          count: 0,
          index: 0,
          pageSize: 5,
          page: 1,
          condition: { ageMin: null, ageMax: null, job: null, region: null, edu: null },
          defaultPhoto: "../server/uploads/nouploadimg.png",
          loginId: "",
          sStatus: "",
          sName: "", //250917 ì„¸ì…˜ì— ì´ë¦„ì¶”ê°€

          isEmpActive: false,
          ageLabel: "ë¬´ê´€",     // computed ëŒ€ì‹  ë¬¸ìì—´
          isPaying: false,      // ë§¤ìš° ê¸°ë³¸ì ì¸ ì¤‘ë³µ ë°©ì§€
          searchOption: "all",
          keyword: "",
          // searchPlaceholder: "ì´ë¦„Â·íšŒì›ë²ˆí˜¸Â·ê±°ì£¼ì§€ ë“±ìœ¼ë¡œ ê²€ìƒ‰",
          gender: "",

          viewMode: 'all',   // â˜… 'all' | 'purchased'


          inCartMap: {},         // { 'C2025-000047': true, ... }
          cartBusy: {},          // { 'C2025-000047': true } í´ë¦­ì¤‘ ì ê¸ˆ

          isAdmin: false,
          naverMap: null,
          naverMarkers: [],
        };
      },
      methods: {
        fnGoSearchPage() {
          alert("ì•„ì§ êµ¬í˜„ ëª»í–ˆìŠµë‹ˆë‹¤.");
        },
        fnGoDetail(memberNo) {
          location.href = `cms_customer_view.html?memberNo=${memberNo}`;
        },

        // ë¦¬ìŠ¤íŠ¸
        // fnList() {
        //   const param = { pageSize: this.pageSize, offset: (this.page - 1) * this.pageSize };
        //   $.ajax({
        //     url: "http://localhost:3009/cms/custlist",
        //     dataType: "json",
        //     type: "GET",
        //     data: param,
        //     success: (data) => {
        //       // alert("ì„œë²„ì—ì„œ ë°›ì€ ë°ì´í„°ëŠ” " + JSON.stringify(data));
        //       this.list = data.list || data.boardList || [];
        //       this.count = data.count || 0;
        //       this.index = Math.ceil(this.count / this.pageSize) || 1;
        //     }
        //   });
        // },
        fnPage(num) {
          this.page = num;
          this.fnList();
        },
        fnMove(move) {
          this.page += move;
          this.fnList();
        },
        fnLoadMore() {
          if (this.page >= this.index) return;
          const next = this.page + 1;
          const param = {
            pageSize: this.pageSize, offset: (next - 1) * this.pageSize
            ,
            sStatus: this.sStatus, // ğŸ‘‡ ì¶”ê°€
            loginId: this.loginId

          };
          $.ajax({
            url: "http://localhost:3009/cms/custlist",
            dataType: "json",
            type: "GET",
            data: param,
            success: (data) => {
              const more = data.list || data.boardList || [];
              this.list = this.list.concat(more);
              this.page = next;
            }
          });
        },

        // ì„¸ì…˜/ë„¤ë¹„
        fnLogout() {
          sessionStorage.removeItem("sessionId");
          sessionStorage.removeItem("sessionStatus");
          alert("ë¡œê·¸ì•„ì›ƒ ë˜ì—ˆìŠµë‹ˆë‹¤.");
          location.href = "cms_login.html";
        },
        fnCustAdd() {
          if (this.sStatus != null) location.href = "cms_customer_add.html";
          else {
            alert("ë¡œê·¸ì¸ í›„ ì´ìš©í•´ì£¼ì„¸ìš”");
            location.href = "cms_login.html";
          }
        },
        fnUserInfoUpdate() {
          if (this.sStatus != null) location.href = `cms_empuser_edit.html?loginId=${this.loginId}`;
          else {
            alert("ë¡œê·¸ì¸ í›„ ì´ìš©í•´ì£¼ì„¸ìš”");
            location.href = "cms_login.html";
          }
        },

        // ê¶Œí•œ
        canEdit(item) {
          const my = (this.loginId || '').trim();
          const owner = (String(item.CREATEBY || '')).trim();
          return !!my && my === owner;
        },
        fnGoEdit(memberNo) {
          location.href = `cms_customer_update.html?memberNo=${memberNo}`;
        },

        // í–‰ í´ë¦­: ê²°ì œ â†’ ì„±ê³µ ì‹œ ìƒì„¸ ì´ë™ ( ê¸°ë³¸ ì½œë°± ë°©ì‹)
        // onRowClick(item) {
        //   // alert("í´ë¦­ì‹œ item ìë£ŒëŠ” " + JSON.stringify(item));
        //   // 1) ì§ì›ì´ë©´ ë°”ë¡œ ì§„ì…
        //   if (this.isEmpActive) {
        //     this.fnGoDetail(item.MEMBER_NO);
        //     return;
        //   }

        //   // 2) ê³ ê°ì´ë©´ì„œ ë³¸ì¸ì´ ë§Œë“  í”„ë¡œí•„ì´ë©´(= ì†Œìœ ì) ë¬´ë£Œ ì§„ì…
        //   //    â€» canEditì—ì„œ loginIdì™€ item.CREATEBYë¥¼ ë¹„êµ ì¤‘
        //   if (this.canEdit(item)) {
        //     this.fnGoDetail(item.MEMBER_NO);
        //     return;
        //   }

        //   // 3) ê³ ê°ì´ë©´ì„œ íƒ€ì¸ í”„ë¡œí•„ì´ë©´ ê²°ì œ í›„ ì´ë™
        //   if (this.isPaying) return;
        //   this.isPaying = true;
        //   this.fnPayment(item, (ok) => {
        //     this.isPaying = false;
        //     if (ok) this.fnGoDetail(item.MEMBER_NO);
        //   });
        // },
        onRowClick: function (item) {
          // 1) ì§ì›/ì‘ì„±ìëŠ” ë°”ë¡œ ì…ì¥
          if (this.isEmpActive) { this.fnGoDetail(item.MEMBER_NO); return; }

          // 2) ë³¸ì¸ì´ ì‘ì„±í•œ í”„ë¡œí•„ì€ ë¬´ë£Œ ì…ì¥
          if (this.canEdit(item)) { this.fnGoDetail(item.MEMBER_NO); return; }

          var self = this;
          var memberNo = String(item.MEMBER_NO || '').trim();

          // 3) 3ì¼ ë‚´ ì—´ëŒê¶Œ ìˆëŠ”ì§€ ë¨¼ì € í™•ì¸
          this.checkAccess(memberNo, function (allowed) {
            if (allowed) {
              // ì´ë¯¸ êµ¬ë§¤í•´ì„œ ì•„ì§ ìœ íš¨ â†’ ê²°ì œ ì—†ì´ ë°”ë¡œ ì§„ì…
              self.fnGoDetail(memberNo);
              return;
            }

            // 4) ì—†ìœ¼ë©´ ê²°ì œ ì§„í–‰
            if (self.isPaying) return;
            self.isPaying = true;

            self.fnPayment(item, function (ok, orderId) {
              self.isPaying = false;
              if (!ok) return;

              // 5) ê²°ì œ ì„±ê³µ â†’ 3ì¼ ì—´ëŒê¶Œ ë¶€ì—¬ í›„ ì´ë™
              self.grantAccess(memberNo, orderId, function (granted) {
                if (granted) {
                  self.fnGoDetail(memberNo);
                } else {
                  alert('ê²°ì œëŠ” ì„±ê³µí–ˆì§€ë§Œ ì—´ëŒê¶Œ ë°œê¸‰ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. ê´€ë¦¬ìì—ê²Œ ë¬¸ì˜í•´ì£¼ì„¸ìš”.');
                }
              });
            });
          });
        },



        // ê²°ì œ (ì½œë°±: true/false)
        // fnPayment(item, done) {
        //   if (!window.IMP || !window.IMP.request_pay) {
        //     alert("ê²°ì œ ëª¨ë“ˆì´ ë¡œë“œë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.");
        //     done(false);
        //     return;
        //   }

        //   // >>> ì—¬ê¸°ì„œë§Œ í•œ ë²ˆë§Œ ì„ ì–¸ (ì¤‘ë³µ ì„ ì–¸ ê¸ˆì§€)
        //   const memberNo = String(item.MEMBER_NO || '').trim();
        //   const buyerName = sessionStorage.getItem("sessionName"); //ë¡œê·¸ì¸ ìˆœê°„ ì„¸ì…˜ì—ì„œë¶€í„° ë„£ì–´ë²„ë¦¼  //String(item.NAME || this.loginId || 'ê³ ê°').trim();
        //   const buyerEmail = "";//String(item.EMAIL || '').trim();              // ì—†ìœ¼ë©´ ë¹ˆ ë¬¸ìì—´
        //   const buyerTel = "";//String(item.PHONE || '010-0000-0000').trim(); // ê¸°ë³¸ê°’
        //   const merchantUid = `cust_${memberNo}_${Date.now()}`;

        //   window.IMP.request_pay({
        //     pg: "html5_inicis",
        //     pay_method: "card",
        //     merchant_uid: merchantUid,
        //     name: `íšŒì›(${memberNo}) í”„ë¡œí•„ ì—´ëŒ`,
        //     amount: 1,
        //     buyer_name: buyerName,
        //     buyer_email: buyerEmail,
        //     buyer_tel: buyerTel
        //   }, (rsp) => {
        //     if (rsp.success) {
        //       console.log("ê²°ì œ ì„±ê³µ:", rsp);
        //       alert("ê²°ì œ ì„±ê³µ");
        //       done(true);
        //     } else {
        //       alert("ê²°ì œê°€ ì‹¤íŒ¨ ë˜ëŠ” ì·¨ì†Œë˜ì—ˆìŠµë‹ˆë‹¤.");
        //       done(false);
        //     }
        //   });
        // },
        fnPayment: function (item, done) {
          if (!window.IMP || !window.IMP.request_pay) {
            alert("ê²°ì œ ëª¨ë“ˆì´ ë¡œë“œë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.");
            done(false);
            return;
          }

          var memberNo = String(item.MEMBER_NO || '').trim();
          var buyerName = sessionStorage.getItem("sessionName") || '';
          var buyerEmail = "";
          var buyerTel = "";
          var merchantUid = 'cust_' + memberNo + '_' + Date.now();

          window.IMP.request_pay({
            pg: "html5_inicis",
            pay_method: "card",
            merchant_uid: merchantUid,
            name: "íšŒì›(" + memberNo + ") í”„ë¡œí•„ ì—´ëŒ",
            amount: 1,
            buyer_name: buyerName,
            buyer_email: buyerEmail,
            buyer_tel: buyerTel
          }, function (rsp) {
            if (rsp.success) {
              // âœ… ê²°ì œë²ˆí˜¸ë¥¼ í•¨ê»˜ ì „ë‹¬ (ì—´ëŒê¶Œ ë°œê¸‰ì— ì‚¬ìš©)
              done(true, merchantUid);
            } else {
              alert("ê²°ì œê°€ ì‹¤íŒ¨ ë˜ëŠ” ì·¨ì†Œë˜ì—ˆìŠµë‹ˆë‹¤.");
              done(false);
            }
          });
        },


        pfx(p) {
          if (!p) return this.defaultPhoto;
          p = String(p).replace(/\\/g, '/');               // \ â†’ /
          return `/server${p.startsWith('/') ? '' : '/'}${p}`;
        },
        onImgError(e) {
          e.target.onerror = null; e.target.src = this.defaultPhoto;
        },
        fnPopup: function (url) {
          // ì²«ë²ˆì§¸ íŒŒë¼ë¯¸í„° : íŒì—…ì„ ë„ìš¸ ì£¼ì†Œ(íŒŒì¼)
          // ë‘ë²ˆì§¸ íŒŒë¼ë¯¸í„° : íŒì—…ì˜ ì´ë¦„ ê°™ì€ ì´ë¦„ì˜ íŒì—…ì€ 2ê°œì´ìƒ ì¶œë ¥ë˜ì§€ ì•ŠëŠ”ë‹¤. (ê³„ì† í´ë¦­í•´ë„)
          // ì„¸ë²ˆì§¸ íŒŒë¼ë¯¸í„° : í¬ê¸°(width, height) ë° ìœ„ì¹˜(left, top)
          let top = (screen.availHeight - 400) / 2
          let left = (screen.availWidth - 400) / 2
          // console.log("ìœ„ì•„ë˜ì¤‘ê°„", mh);
          // console.log("ì¢Œìš°ì¤‘ê°„", mw);
          // src="../media/skj_img.jpg"
          window.open(url, "popup", `width=500, height=500, left=${left}, top=${top}`);
        },

        fnSearch() {
          // ìƒˆ ê²€ìƒ‰ì€ 1í˜ì´ì§€ë¶€í„°
          this.page = 1;
          this.fnList();
        },
        fnReset() {
          this.searchOption = "all";
          this.keyword = "";
          this.gender = "";
          this.page = 1;
          this.fnList();
        },
        // ë¦¬ìŠ¤íŠ¸ (ê²€ìƒ‰ íŒŒë¼ë¯¸í„° í¬í•¨)
        fnList() {
          const param = {
            pageSize: this.pageSize,
            offset: (this.page - 1) * this.pageSize,
            option: this.searchOption,
            keyword: this.keyword,
            gender: this.gender,
            // ğŸ‘‡ ì¶”ê°€
            sStatus: this.sStatus,
            loginId: this.loginId
          };
          $.ajax({
            url: "http://localhost:3009/cms/custlist",
            dataType: "json",
            type: "GET",
            data: param,
            success: (data) => {
              this.list = data.list || data.boardList || [];
              this.count = data.count || 0;
              this.index = Math.ceil(this.count / this.pageSize) || 1;

              // â–¼ ëª©ë¡ì´ ë°”ë€” ë•Œë§ˆë‹¤ ì¥ë°”êµ¬ë‹ˆ ìƒíƒœ ë™ê¸°í™”
              if (!this.isEmpActive) this.loadCartFlags();
            }
          });
        },
        // fnList: function () {
        //   var url = "http://localhost:3009/cms/custlist";   // ê¸°ë³¸: ì „ì²´ ëª©ë¡
        //   if (this.viewMode === 'purchased') {
        //     // â˜… â€œë‚´ê°€ ê²°ì œí•´ì„œ ì•„ì§ ìœ íš¨í•œ íšŒì›ë“¤â€ ì „ìš© API (ë°±ì—”ë“œì—ì„œ ë§Œë“¤ì–´ë‘” ì¡°ì¸ ê²°ê³¼)
        //     //    ì‘ë‹µ í˜•íƒœëŠ” { list, count }ë¥¼ custlistì™€ ë™ì¼í•˜ê²Œ ë§ì¶°ë‘ë©´ í”„ë¡ íŠ¸ ìˆ˜ì •ì´ ìµœì†Œí™”ë¨
        //     url = "http://localhost:3009/cms/access/mylist";
        //   }

        //   var param = {
        //     pageSize: this.pageSize,
        //     offset: (this.page - 1) * this.pageSize,
        //     option: this.searchOption,
        //     keyword: this.keyword,
        //     sStatus: this.sStatus,
        //     loginId: this.loginId          // â˜… viewerId ë¡œ ë°±ì—”ë“œì—ì„œ ì‚¬ìš©
        //   };

        //   $.ajax({
        //     url: url,
        //     dataType: "json",
        //     type: "GET",
        //     data: param,
        //     success: (data) => {
        //       this.list = data.list || [];
        //       this.count = data.count || 0;
        //       this.index = Math.ceil(this.count / this.pageSize) || 1;
        //     }
        //   });
        // },

        displayName(item) {
          // ì§ì›ì´ë©´ ì´ë¦„ ê·¸ëŒ€ë¡œ ë…¸ì¶œ
          if (this.isEmpActive) return item.NAME || '-';

          // ê³ ê°ì´ë©´: ë³¸ì¸ì´ ì‘ì„±í•œ í”„ë¡œí•„ë§Œ ì´ë¦„ ë…¸ì¶œ, ê·¸ ì™¸ëŠ” ë¹„ê³µê°œ
          const my = (this.loginId || '').trim();
          const owner = (String(item.CREATEBY || '')).trim();
          if (my && my === owner) return item.NAME || '-';

          // ë‹¤ë¥¸ ê³ ê°ì˜ ì´ë¦„ì€ ìˆ¨ê¹€
          return 'ë¹„ê³µê°œ';
        },

        // (A) ì—´ëŒê¶Œ ë³´ìœ  ì—¬ë¶€ í™•ì¸: allowed(true/false)ë¥¼ ì½œë°±ìœ¼ë¡œ ëŒë ¤ì¤Œ
        checkAccess: function (memberNo, cb) {
          $.ajax({
            url: 'http://localhost:3009/cms/access/check',
            type: 'GET', dataType: 'json',
            data: { viewerId: this.loginId, memberNo: memberNo },
            success: function (res) { cb(!!(res && res.allowed)); },
            error: function () { cb(false); }
          });
        },

        // (B) ì—´ëŒê¶Œ ë°œê¸‰/ì—°ì¥: ì„±ê³µ ì—¬ë¶€ë¥¼ ì½œë°±ìœ¼ë¡œ ëŒë ¤ì¤Œ
        grantAccess: function (memberNo, orderId, cb) {
          $.ajax({
            url: 'http://localhost:3009/cms/access/grant',
            type: 'GET', dataType: 'json',
            data: { viewerId: this.loginId, memberNo: memberNo, orderId: orderId, amount: 1, days: 3 },
            success: function (res) { cb(!!(res && res.ok)); },
            error: function () { cb(false); }
          });
        },


        // setMode: function (mode) {
        //   this.viewMode = mode;
        //   this.page = 1;            // ì²« í˜ì´ì§€ë¶€í„°
        //   this.fnList();            // ëª©ë¡ ë‹¤ì‹œ ë¡œë“œ
        // },


        // fnOpenPurchased: function () {
        //   if (!this.loginId) { alert('ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.'); return; }

        //   var w = 980, h = 720;
        //   var left = (screen.availWidth - w) / 2;
        //   var top = (screen.availHeight - h) / 2;

        //   var url = 'cms_customer_purchased_list.html?viewerId=' + encodeURIComponent(this.loginId);
        //   window.open(url, 'purchased_list',
        //     'width=' + w + ',height=' + h + ',left=' + left + ',top=' + top + ',resizable=yes,scrollbars=yes');
        // },

        fnGoPurchased: function () {
          if (!this.loginId) { alert('ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.'); return; }
          var url = 'cms_customer_purchased_list.html?viewerId=' + encodeURIComponent(this.loginId);
          // ë’¤ë¡œê°€ê¸°ë¥¼ ê°€ëŠ¥í•˜ê²Œ í•˜ë ¤ë©´ â†“ (ê¸°ë³¸ ì¶”ì²œ)
          location.href = url;
          // ë’¤ë¡œê°€ê¸°ë¥¼ ë§‰ê³  ì‹¶ìœ¼ë©´ ëŒ€ì‹  â†“ ì‚¬ìš©
          // location.replace(url);
        },



        // ì¥ë°”êµ¬ë‹ˆ í˜ì´ì§€ ì´ë™
        goCartPage() {
          if (!this.loginId) { alert('ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.'); return; }
          location.href = 'cms_customer_cart.html?viewerId=' + encodeURIComponent(this.loginId);
        },

        // í˜„ì¬ í˜ì´ì§€ì˜ ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¨ ë’¤, ë‚´ ì¥ë°”êµ¬ë‹ˆ í•­ëª©ë“¤ì„ í•œ ë²ˆì— ë°›ì•„ì™€ ë§¤í•‘
        loadCartFlags() {
          if (!this.loginId) return;
          $.ajax({
            url: 'http://localhost:3009/cms/cart/list',
            type: 'GET', dataType: 'json',
            data: { viewerId: this.loginId, pageSize: 9999, offset: 0 },
            success: (res) => {
              const map = {};
              (res.list || []).forEach(r => { map[String(r.MEMBER_NO)] = true; });
              this.inCartMap = map;
            }
          });
        },
        isInCart(memberNo) {
          return !!this.inCartMap[String(memberNo)];
        },

        // ë‹´ê¸°/ë¹¼ê¸° í† ê¸€
        toggleCart(item) {
          const memberNo = String(item.MEMBER_NO);
          if (!this.loginId) { alert('ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.'); return; }
          if (this.cartBusy[memberNo]) return;

          this.$set ? this.$set(this.cartBusy, memberNo, true) : (this.cartBusy[memberNo] = true);

          const inCart = this.isInCart(memberNo);
          const url = inCart ? 'http://localhost:3009/cms/cart/remove' : 'http://localhost:3009/cms/cart/add';
          const params = { viewerId: this.loginId, memberNo };

          $.ajax({
            url, type: 'GET', dataType: 'json', data: params,
            success: () => {
              // ë‚™ê´€ì  ì—…ë°ì´íŠ¸
              if (inCart) delete this.inCartMap[memberNo];
              else this.inCartMap[memberNo] = true;
            },
            error: () => { alert('ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.'); },
            complete: () => { this.cartBusy[memberNo] = false; }
          });
        },

        initNaverMap() {
          if (this.naverMap) return;
          // ê¸°ë³¸ ì¤‘ì‹¬: ì„œìš¸ ì‹œì²­ ê·¼ì²˜
          this.naverMap = new naver.maps.Map('adminMap', {
            center: new naver.maps.LatLng(37.5665, 126.9780),
            zoom: 10
          });
        },

        loadCoordsAndRender() {
          $.ajax({
            url: 'http://localhost:3009/cms/coords',
            type: 'GET', dataType: 'json',
            data: { loginId: this.loginId, sStatus: this.sStatus },
            success: (res) => {
              const rows = res.list || [];
              this.renderNaverMarkers(rows);
            }
          });
        },

        renderNaverMarkers(rows) {
          // ê¸°ì¡´ ë§ˆì»¤ ì œê±°
          this.naverMarkers.forEach(m => m.setMap(null));
          this.naverMarkers = [];

          const bounds = new naver.maps.LatLngBounds();
          rows.forEach(r => {
            const lat = Number(r.LATITUDE), lng = Number(r.LONGITUDE);
            if (!isFinite(lat) || !isFinite(lng)) return;
            const pos = new naver.maps.LatLng(lat, lng);

            const marker = new naver.maps.Marker({
              position: pos,
              map: this.naverMap
            });

            const displayName = r.NAME || 'ë¹„ê³µê°œ';
            const html =
              `<div style="font-size:13px;line-height:1.4">
           <div><b>íšŒì›ë²ˆí˜¸</b> ${r.MEMBER_NO}</div>
           <div><b>ì„±ë³„</b> ${r.GENDER || '-'}</div>
           <div><b>ì´ë¦„</b> ${displayName} </div>
         </div>`;

            const infowin = new naver.maps.InfoWindow({ content: html });
            naver.maps.Event.addListener(marker, 'click', () => {
              infowin.open(this.naverMap, marker);
            });

            this.naverMarkers.push(marker);
            bounds.extend(pos);
          });

          if (!bounds.isEmpty()) {
            this.naverMap.fitBounds(bounds);
          } else {
            this.naverMap.setCenter(new naver.maps.LatLng(37.5665, 126.9780));
            this.naverMap.setZoom(10);
          }
        },

      },
      mounted() {
        // ì„¸ì…˜
        self = this;
        const sId = sessionStorage.getItem("sessionId");
        const sStatus = sessionStorage.getItem("sessionStatus");
        let sName = sessionStorage.getItem("sessionName");

        self.loginId = sId || "";
        self.sStatus = sStatus || "";
        self.sName = sName || "";

        if (!this.loginId) {
          alert("ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.");
          location.href = "cms_login.html";
          return;
        }
        this.isEmpActive = (this.sStatus === 'active');
        this.isAdmin = (String(this.loginId).toLowerCase() === 'admin'); // â˜… íšŒì¥ íŒë³„
        // ì•„ì£¼ ë‹¨ìˆœí•œ ageLabel ê³„ì‚°(ì´ˆê¸° í•œ ë²ˆ)
        // const { ageMin, ageMax } = this.condition || {};
        // if (ageMin && ageMax) this.ageLabel = ageMin + "~" + ageMax;
        // else if (ageMin && !ageMax) this.ageLabel = ageMin + "+";
        // else if (!ageMin && ageMax) this.ageLabel = "~" + ageMax;
        // else this.ageLabel = "ë¬´ê´€";

        // ì•„ì„í¬íŠ¸ ì´ˆê¸°í™”
        if (window.IMP && window.IMP.init) {
          window.IMP.init(userCode);
        }

        self.fnList();
        // â˜… ì§€ë„: admin ë˜ëŠ” ì§ì›ì¼ ë•Œë§Œ ì´ˆê¸°í™” + ë°ì´í„° ë¡œë“œ
        if (this.isAdmin || this.isEmpActive) {
          this.$nextTick(() => {
            this.initNaverMap();
            this.loadCoordsAndRender();
          });
        }
      }
    });

    app.mount('#app');
  </script>
</body>

</html>