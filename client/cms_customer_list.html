<!DOCTYPE html>
<html lang="ko">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width,initial-scale=1.0">
  <title>고객 목록 및 검색</title>
  <script src="https://code.jquery.com/jquery-3.7.1.js" crossorigin="anonymous"></script>
  <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
  <style>
    /* ===== 기존 디자인 그대로 ===== */
    body {
      margin: 0;
      background: #f5f6f8;
      font-family: Arial, sans-serif;
      color: #222
    }

    #app {
      display: flex;
      justify-content: center;
      align-items: flex-start;
      min-height: 100vh;
      padding: 24px 12px;
      box-sizing: border-box
    }

    .container {
      width: 1100px;
      max-width: 100%;
      background: #fff;
      border-radius: 14px;
      padding: 18px;
      box-shadow: 0 8px 22px rgba(0, 0, 0, .08);
      border: 1px solid #eef2f7
    }

    .title {
      margin: 0 0 12px;
      text-align: center;
      font-size: 1.35rem;
      font-weight: 800;
      color: #223;
      display: flex;
      /* 제목과 로그인 id를 한 줄 배치 */
      justify-content: space-between;
      /*좌측은 제목, 우측은 로그인 id*/
    }

    .notice {
      background: #f8fbff;
      border: 1px solid #e6f0ff;
      color: #334;
      padding: 12px 14px;
      border-radius: 10px;
      line-height: 1.6
    }

    .warn {
      color: #c62828;
      font-weight: 800
    }

    .section {
      margin-top: 16px
    }

    .section__hd {
      margin: 0 0 10px;
      padding-bottom: 6px;
      font-size: 1.02rem;
      font-weight: 800;
      color: #2b3a55;
      border-bottom: 2px solid #e8eefc;
      display: flex;
      align-items: center
    }

    .btn {
      display: inline-block;
      padding: 10px 14px;
      border-radius: 10px;
      border: none;
      cursor: pointer;
      font-weight: 800;
      background: #3a7afe;
      color: #fff;
      box-shadow: 0 4px 10px rgba(58, 122, 254, .18)
    }

    .btn:hover {
      background: #2b68ea
    }

    .btn--ghost {
      background: #fff;
      color: #3a7afe;
      border: 1px solid #c8d4ff;
      box-shadow: none
    }

    .btn--ghost:hover {
      background: #f4f7ff
    }

    .chips {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      align-items: center;
      background: #fbfdff;
      border: 1px solid #eef1f5;
      border-radius: 12px;
      padding: 12px
    }

    .chip {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      background: #f3f6ff;
      border: 1px solid #dee7ff;
      color: #2845a7;
      padding: 8px 10px;
      border-radius: 999px;
      font-weight: 700;
      font-size: .92rem
    }

    .chip b {
      color: #24324d
    }

    .table-wrap {
      border: 1px solid #e9edf3;
      border-radius: 12px;
      overflow: auto;
      background: #fff;
      box-shadow: 0 2px 10px rgba(0, 0, 0, .03)
    }

    table.member-table {
      /* width: 1400px; */
      min-width: 100%;
      border-collapse: collapse;
      table-layout: fixed
    }

    .member-table th,
    .member-table td {
      border: 1px solid #e5e9f2;
      padding: 2px 2px;
      text-align: center;
      white-space: nowrap
    }

    .member-table thead th {
      position: sticky;
      top: 0;
      background: #f6f9ff;
      color: #2b3a55;
      z-index: 1;
      font-weight: 800
    }

    .member-table tbody tr:nth-child(even) td {
      background: #fafcff
    }

    .member-table tbody tr:hover td {
      background: #f0f6ff
    }

    .photo-cell img {
      width: 48px;
      height: 56px;
      object-fit: cover;
      border-radius: 6px;
      border: 1px solid #eee;
      box-shadow: 0 2px 6px rgba(0, 0, 0, .05)
    }

    .toolbar {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-top: 12px
    }

    .stat {
      color: #556;
      font-weight: 700
    }

    .pager a {
      margin: 0 6px;
      text-decoration: none;
      color: #3a7afe;
      font-weight: 800
    }

    .pager a.active {
      color: #d33;
      font-size: 1.05rem
    }

    .toolbar-right {
      display: flex;
      align-items: center;
      gap: 10px
    }

    select.page-select {
      border: 1px solid #c8d4ff;
      border-radius: 8px;
      padding: 6px 8px
    }

    .login-id {
      font-size: 14px;
      color: #555;
    }
  </style>
</head>

<body>
  <div id="app">
    <div class="container">

      <h2 class="title">고객 목록 및 검색
        <span class="login-id" v-if="loginId">로그인 ID : {{ loginId }}</span>
        <button class="btn" @click="fnUserInfoUpdate" v-if="isEmpActive">사원본인정보수정</button>
        <button class="btn" @click="fnLogout">로그아웃</button>
      </h2>

      <div class="notice">
        고객 검색 목록은 <span class="warn">프로필 공개에 동의한 회원정보만 노출</span>됩니다.
      </div>

      <div class="section">
        <div class="section__hd">선택하신 조건</div>
        <div class="chips">
          <span class="chip"><b>연령</b> {{ ageLabel }}</span>
          <span class="chip"><b>직업</b> {{ condition.job || '무관' }}</span>
          <span class="chip"><b>거주지</b> {{ condition.region || '무관' }}</span>
          <span class="chip"><b>학력</b> {{ condition.edu || '무관' }}</span>

          <span style="flex:1 0 auto"></span>
          <button class="btn btn--ghost" @click="fnGoSearchPage">다시검색</button>
        </div>
      </div>

      <div class="section">
        <div class="section__hd">
          고객 목록
          <button class="btn" style="margin-left:auto" @click="fnCustAdd" v-if="isEmpActive">고객 추가</button>
        </div>

        <div class="table-wrap">
          <table class="member-table">
            <thead>
              <tr>
                <th style="width:70px">사진</th>
                <th style="width:120px">회원번호</th>
                <th style="width:120px">이름</th>
                <th style="width:100px">출생년</th>
                <th style="width:120px">결혼경력</th>
                <th style="width:180px">직업</th>
                <th style="width:120px">거주지</th>
                <!-- <th style="width:150px">프로필 열람일</th> -->
                <th style="width:100px" v-if="isEmpActive">수정</th>
              </tr>
            </thead>

            <!-- DB 결과 -->
            <tbody v-if="list.length > 0">
              <tr v-for="item in list" :key="item.MEMBER_NO" @click="fnGoDetail(item.MEMBER_NO)"
                style="cursor:pointer;">
                <td class="photo-cell"><img :src="item.MAIN_PHOTO_URL || defaultPhoto" :alt="item.MEMBER_NO"></td>
                <td>{{ item.MEMBER_NO }}</td>
                <td>{{ item.NAME || '-' }}</td>
                <td>{{ item.BIRTH_YEAR || '-' }}</td>
                <td>{{ item.MARITAL || '-' }}</td>
                <td>{{ item.JOB || '-' }}</td>
                <td>{{ item.ADDRESS || '-' }}</td>
                <!-- <td>{{ item.PROFILE_VIEWED_AT || '-' }}</td> -->
                <!-- <td><button class="btn btn--ghost" @click.stop="fnGoDetail_잠시주석(item.MEMBER_NO)" v-if="isEmpActive">수정</button></td> -->
                <td v-if="isEmpActive">
                  <button class="btn btn--ghost" @click.stop="fnGoEdit(item.MEMBER_NO)" v-if="canEdit(item)">
                    수정
                  </button>
                </td>
              </tr>
            </tbody>

            <!-- 결과 없을 때 -->
            <tbody v-else>
              <tr>
                <td colspan="9">조회된 데이터가 없습니다.</td>
              </tr>
            </tbody>
          </table>
        </div>

        <div class="toolbar">
          <div class="stat">총 {{ count }}건 / {{ page }} 페이지</div>
          <div class="toolbar-right">
            <select class="page-select" v-model="pageSize" @change="fnList">
              <option value="5">5개씩</option>
              <option value="10">10개씩</option>
              <option value="15">15개씩</option>
              <option value="20">20개씩</option>
            </select>

            <div class="pager">
              <a href="javascript:;" v-if="page != 1" @click="fnMove(-1)">◀</a>
              <a class="index" href="javascript:;" v-for="num in index" :class="{active:num==page}"
                @click="fnPage(num)">
                <span v-if="num == page">{{num}}</span>
                <span v-else>{{num}}</span>
              </a>
              <a href="javascript:;" v-if="page != index" @click="fnMove(1)">▶</a>
            </div>

            <button class="btn" @click="fnLoadMore" :disabled="page>=index">+ 더보기</button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script>
    const app = Vue.createApp({
      data() {
        return {
          list: [],            // 표에 그릴 데이터
          count: 0,            // 총 건수
          index: 0,            // 총 페이지 수
          pageSize: 5,        // 한 페이지 크기
          page: 1,             // 현재 페이지
          condition: { ageMin: null, ageMax: null, job: null, region: null, edu: null },
          defaultPhoto: "../photos/noimg.jpg",
          loginId: "",  // 화면에 표시할 로그인 아이디
          sStatus: "",   //로그인 사용자의 권한상태?를 화면에 표현할까 고민중 
          isEmpActive: false      // 고객과 직원 간의 화면 제어에 바로 쓰는 플래그
        };
      },
      methods: {
        fnGoSearchPage: function () {
          alert("아직 구현 못했습니다.");
          // location.href = "classic_member_search.asp"; 
        },
        fnGoDetail: function (memberNo) {
          let self = this;
          // alert(self.sId);
          // alert(self.sStatus);
          location.href = `cms_customer_view.html?memberNo=${memberNo}`;
          // location.href = "/profile/" + memberNo; 
        },

        // 학원 스타일 리스트 조회
        fnList: function () {
          let self = this;
          let param = {
            pageSize: self.pageSize,
            offset: (self.page - 1) * self.pageSize
            // 필요시 조건 추가 가능: ageMin, ageMax, region 등
          };
          $.ajax({
            url: "http://localhost:3009/cms/custlist",
            dataType: "json",
            type: "GET",
            data: param,
            success: function (data) {
              // 서버가 list 또는 boardList로 내려줄 수 있으니 둘 다 대응
              self.list = data.list || data.boardList || [];
              self.count = data.count || 0;
              self.index = Math.ceil(self.count / self.pageSize) || 1;
            }
          });
        },

        // 페이지 번호 클릭
        fnPage: function (num) {
          let self = this;
          self.page = num;
          self.fnList();
        },

        // ◀ / ▶ 이동
        fnMove: function (move) {
          let self = this;
          self.page += move;
          self.fnList();
        },

        // + 더보기: 다음 페이지 데이터 이어붙이기(옵션)
        fnLoadMore: function () {
          let self = this;
          if (self.page >= self.index) return;
          let next = self.page + 1;

          let param = {
            pageSize: self.pageSize,
            offset: (next - 1) * self.pageSize
          };
          $.ajax({
            url: "http://localhost:3009/cms/custlist",
            dataType: "json",
            type: "GET",
            data: param,
            success: function (data) {
              let more = data.list || data.boardList || [];
              self.list = self.list.concat(more);
              self.page = next;
            }
          });
        },

        // 페이지 크기 변경
        fnSetPageSize: function () {
          let self = this;
          self.page = 1;
          self.fnList();
        },

        fnLogout: function () {
          sessionStorage.removeItem("sessionId"); //내가 넣은 것 지우기
          sessionStorage.removeItem("sessionStatus");  //내가 넣은 것 지우기
          alert("로그아웃 되었습니다.");
          location.href = "cms_login.html"
        },

        fnCustAdd: function () {
          // location.href = "cms_customer_add.html";
          let self = this;
          console.log(self.sStatus); //로그인하면 값이 있음,   로그인 안하면 없음
          if (self.sStatus != null) {
            location.href = "cms_customer_add.html"
          } else {
            alert("로그인 후 이용해주세요");
            location.href = "cms_login.html";
          }
        },

        fnUserInfoUpdate: function () {
          let self = this;
          console.log(self.sStatus); //로그인하면 값이 있음,   로그인 안하면 없음
          if (self.sStatus != null) {
            location.href = `cms_empuser_edit.html?loginId=${this.loginId}`
          } else {
            alert("로그인 후 이용해주세요");
            location.href = "cms_login.html";
          }
        },

        canEdit(item) {
          // 세션ID와 생성자 컬럼을 문자열로 비교 (null/공백 방어)
          const my = (this.loginId || '').trim();
          const owner = (String(item.CREATEBY || '')).trim();
          return !!my && my === owner;
        },
        fnGoEdit(memberNo) {
          // 수정 페이지로 이동 (원하는 경로로 바꿔도 됨)
          location.href = `cms_customer_update.html?memberNo=${memberNo}`;
        },


      },
      mounted() {
        let self = this;
        let sId = sessionStorage.getItem("sessionId"); //서버에서 set할때 이름이 sessionID이었음 그걸 get으로 꺼냄
        let sStatus = sessionStorage.getItem("sessionStatus");

        self.loginId = sId || "";
        self.sStatus = sStatus || "";

        // (선택) 로그인 안 한 상태면 접근 차단하고 로그인 페이지로 보냄
        if (!self.loginId) {
          alert("로그인이 필요합니다.");
          location.href = "cms_login.html"; // 실제 로그인 페이지 경로로 변경
        }


        self.isEmpActive = (self.sStatus === 'active');
        self.fnList();
      }
    });
    app.mount('#app');
  </script>
</body>

</html>