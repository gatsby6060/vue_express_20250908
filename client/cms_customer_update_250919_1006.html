<!DOCTYPE html>
<html lang="ko">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1.0" />
  <title>고객 정보 수정</title>
  <script src="https://code.jquery.com/jquery-3.7.1.js" integrity="sha256-eKhayi8LEQwp4NKxN+CfCh+3qOVUtJn3QNZ0TciWLP4="
    crossorigin="anonymous"></script>
  <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
  <!-- 지오코더 반드시 포함 -->
  <script src="https://oapi.map.naver.com/openapi/v3/maps.js?ncpKeyId=jquy82alxa&submodules=geocoder"></script>
  <style>
    [v-cloak] {
      display: none
    }

    body {
      margin: 0;
      background: #f5f6f8;
      font-family: Arial, sans-serif
    }

    #app {
      display: flex;
      justify-content: center;
      align-items: flex-start;
      min-height: 100vh;
      padding: 28px 12px;
      box-sizing: border-box
    }

    .container {
      width: 980px;
      max-width: 100%;
      background: #fff;
      border-radius: 14px;
      box-shadow: 0 6px 16px rgba(0, 0, 0, .08);
      padding: 22px
    }

    .title {
      margin: 0 0 16px;
      text-align: center;
      font-size: 1.4rem;
      font-weight: 800;
      color: #223
    }

    .section {
      margin-top: 22px
    }

    .section__hd {
      margin: 0 0 10px;
      padding-bottom: 6px;
      font-size: 1.05rem;
      font-weight: 800;
      color: #2b3a55;
      border-bottom: 2px solid #e8eefc
    }

    .card {
      background: #fff;
      border: 1px solid #e9edf3;
      border-radius: 12px;
      padding: 12px
    }

    .profile {
      display: grid;
      grid-template-columns: 220px 1fr;
      gap: 16px;
      align-items: start;
      border: 1px solid #e9edf3;
      border-radius: 12px;
      padding: 14px;
      background: #fbfdff
    }

    .photo-main {
      width: 180px;
      height: 180px;
      object-fit: cover;
      display: block;
      margin: 0 auto 10px;
      border-radius: 12px;
      border: 4px solid #f1f4ff
    }

    .grid-2 {
      display: grid;
      grid-template-columns: repeat(2, minmax(0, 1fr));
      gap: 10px
    }

    .field {
      display: flex;
      gap: 10px;
      align-items: center;
      margin: 6px 0
    }

    .field label {
      width: 100px;
      color: #566
    }

    .field input,
    .field textarea,
    .field select {
      flex: 1;
      padding: 8px;
      border: 1px solid #e5e9f2;
      border-radius: 8px;
      min-width: 0
    }

    .info-grid {
      display: grid;
      grid-template-columns: repeat(2, minmax(0, 1fr));
      gap: 10px;
      margin-top: 12px
    }

    .info-item {
      background: #f8fafc;
      border: 1px solid #eef1f5;
      border-radius: 10px;
      padding: 10px;
      text-align: left
    }

    .info-item b {
      display: block;
      color: #566;
      margin-bottom: 4px
    }

    .table-wrap {
      overflow-x: auto;
      -webkit-overflow-scrolling: touch
    }

    table {
      width: 100%;
      border-collapse: collapse;
      table-layout: fixed
    }

    th,
    td {
      border: 1px solid #e5e9f2;
      padding: 8px 10px;
      text-align: center;
      vertical-align: middle
    }

    thead th {
      background: #f6f9ff;
      color: #2b3a55;
      font-weight: 800
    }

    tbody tr:nth-child(even) td {
      background: #fafcff
    }

    td input {
      width: 100%;
      min-width: 0;
      box-sizing: border-box
    }

    .btn-row {
      text-align: center;
      margin-top: 16px
    }

    .btn {
      display: inline-block;
      padding: 10px 16px;
      border-radius: 10px;
      border: none;
      background: #3a7afe;
      color: #fff;
      font-weight: 800;
      cursor: pointer;
      box-shadow: 0 4px 10px rgba(58, 122, 254, .18)
    }

    .btn+.btn {
      margin-left: 8px
    }

    .btn:hover {
      background: #2b68ea
    }

    .btn--ghost {
      background: #eef3ff;
      color: #2b3a55
    }

    .mini {
      padding: 6px 10px;
      border-radius: 8px
    }

    .danger {
      background: #ff5a5a
    }

    .btn:disabled {
      opacity: .55;
      cursor: not-allowed
    }

    .text-muted {
      text-align: center;
      margin-top: 14px;
      color: #666
    }

    .copyright {
      color: #98a0aa;
      font-size: .9rem
    }

    @media (max-width:760px) {
      .profile {
        grid-template-columns: 1fr
      }

      .grid-2 {
        grid-template-columns: 1fr
      }
    }
  </style>
</head>

<body>
  <div id="app" v-cloak>
    <div class="container">
      <h2 class="title">고객 정보 수정</h2>

      <!-- 상단: 좌 사진/우 입력 -->
      <div class="profile">
        <!-- 사진 -->
        <div class="card">
          <img class="photo-main" :src="photoPreview" @error="onImgError" alt="메인 사진">
          <div class="field">
            <!-- <label>사진 URL</label>
            <input v-model="form.mainPhotoUrl" @input="updatePreview" placeholder="/server/.... 또는 http(s)://..."> -->
          </div>
          <div class="field">
            <label>사진 업로드</label>
            <input type="file" ref="fileInput" accept="image/*">
          </div>
        </div>

        <!-- 기본 정보 + PR -->
        <div class="card">
          <div class="section__hd">기본 정보</div>
          <div class="grid-2">
            <div>
              <div class="field"><label>회원번호</label><input v-model="form.memberNo" readonly></div>
              <div class="field"><label>성명</label><input v-model.trim="form.name" placeholder="이름"></div>
              <div class="field"><label>출생년</label><input v-model.number="form.birthYear" type="number"
                  placeholder="예) 1988"></div>
              <div class="field"><label>전화번호</label><input v-model.trim="form.phone" placeholder="010-...."></div>
              <div class="field"><label>이메일</label><input v-model.trim="form.email" placeholder="test@..."></div>

            </div>
            <div>
              <div class="field" style="align-items:flex-start">
                <label>나의 PR</label>
                <textarea v-model="form.pr" rows="7" placeholder="자기소개를 입력하세요" style="white-space:pre-line;"></textarea>
              </div>
              <div class="field">
                <label>성별</label>
                <select v-model="form.gender">
                  <option value="N">선택안함(N)</option>
                  <option value="M">남(M)</option>
                  <option value="F">여(F)</option>
                </select>
              </div>
            </div>

          </div>
          <div class="field">
            <label>거주지</label>
            <input v-model.trim="form.address" placeholder="주소검색 버튼을 이용하세요" readonly @click="fnSearchAddr">
            <button class="btn mini" type="button" @click="fnSearchAddr">주소검색</button>
          </div>
        </div>
      </div>

      <!-- 신상 -->
      <div class="section">
        <div class="section__hd">신상 정보</div>
        <div class="info-grid">
          <div class="info-item"><b>신장(cm)</b><input v-model.number="form.height" type="number" placeholder="예) 175">
          </div>
          <div class="info-item"><b>체중(kg)</b><input v-model.number="form.weight" type="number" placeholder="예) 70">
          </div>
        </div>
      </div>

      <!-- 학력 -->
      <div class="section">
        <div class="section__hd">학력 정보</div>
        <div class="card">
          <div class="table-wrap">
            <table>
              <thead>
                <tr>
                  <th>구분</th>
                  <th>학교명</th>
                  <th>전공</th>
                  <th>입학년도</th>
                  <th>졸업년도</th>
                  <th>소재지</th>
                  <th>관리</th>
                </tr>
              </thead>
              <tbody>
                <tr v-for="(it,idx) in educations" :key="'edu-'+idx">
                  <td><input v-model.trim="it.level" placeholder="고등/대학교/대학원"></td>
                  <td><input v-model.trim="it.school"></td>
                  <td><input v-model.trim="it.major"></td>
                  <td><input v-model.trim="it.enter" placeholder="YYYY"></td>
                  <td><input v-model.trim="it.graduate" placeholder="YYYY"></td>
                  <td><input v-model.trim="it.area"></td>
                  <td><button class="btn mini danger" @click="educations.splice(idx,1)">삭제</button></td>
                </tr>
                <tr v-if="educations.length===0">
                  <td colspan="7">행이 없습니다. 아래 버튼으로 추가하세요.</td>
                </tr>
              </tbody>
            </table>
          </div>
          <div class="btn-row"><button class="btn mini btn--ghost" @click="addEdu">학력 추가</button></div>
        </div>
      </div>

      <!-- 버튼 -->
      <div class="btn-row">
        <button class="btn" @click="save" :disabled="!canEdit">저장(수정)</button>
        <button class="btn btn--ghost" @click="goDetail">현재고객정보상세 페이지로 이동</button>
        <button class="btn btn--ghost" @click="goList">고객들 목록 리스트로 이동</button>
        <div class="text-muted" v-if="!canEdit" style="margin-top:8px;">작성자만 수정할 수 있습니다. (작성자: {{ ownerId || '-' }})
        </div>
      </div>

      <div class="text-muted">담당 데이터 입력자 : {{ ownerId || '-' }}</div>
      <div class="text-muted copyright">Copyright © 전경환 All Rights Reserved.</div>
    </div>
  </div>

  <script>
    function qp(name) { const v = new URLSearchParams(location.search).get(name); return v ? decodeURIComponent(v) : ""; }

    const app = Vue.createApp({
      data() {
        return {
          memberNo: qp('memberNo') || '',
          sessionId: sessionStorage.getItem('sessionId') || '',
          sessionStatus: sessionStorage.getItem('sessionStatus') || '',
          ownerId: '',
          // 폼 + 좌표
          form: {
            memberNo: '', name: '', pr: '', address: '', email: '', phone: '',
            birthYear: null, height: null, weight: null, gender: 'N',
            mainPhotoUrl: '', lat: null, lng: null
          },
          originalAddress: '',  // 주소 변경 여부 판단용
          educations: [],
          canEdit: false,
          photoPreview: '../server/uploads/nouploadimg.png',
          defaultPhoto: '../server/uploads/nouploadimg.png'
        }
      },
      mounted() {
        if (!this.sessionId) { alert('로그인이 필요합니다.'); location.href = 'cms_login.html'; return; }
        if (!this.memberNo) { alert('memberNo 파라미터가 없습니다.'); history.back(); return; }
        // 팝업 콜백용
        window.vueObj = this;
        this.loadAll();
      },
      methods: {
        // ===== 공통 유틸 =====
        pfx(p) { if (!p) return this.defaultPhoto; p = String(p).replace(/\\/g, '/'); return `/server${p.startsWith('/') ? '' : '/'}${p}`; },
        onImgError(e) { e.target.onerror = null; e.target.src = this.defaultPhoto; },
        updatePreview() { const u = this.form.mainPhotoUrl || ''; this.photoPreview = u ? this.pfx(u) : this.defaultPhoto; },
        addEdu() { this.educations.push({ level: '', school: '', major: '', enter: '', graduate: '', area: '' }); },

        // ===== 로딩 =====
        async loadAll() {
          try {
            // 1) 프로필
            await $.ajax({
              url: 'http://localhost:3009/cms/customerinfo/',
              type: 'GET', dataType: 'json',
              data: { memberNo: this.memberNo },
              success: (res) => {
                const info = res?.info || {};
                this.ownerId = info.CREATEBY || '';
                this.form.memberNo = info.MEMBER_NO || this.memberNo;
                this.form.name = info.NAME || '';
                this.form.pr = info.PR || '';
                this.form.address = info.ADDRESS || '';
                this.form.email = info.EMAIL || '';
                this.form.phone = info.PHONE || '';
                this.form.birthYear = info.BIRTH_YEAR || null;
                this.form.height = info.HEIGHT || null;
                this.form.weight = info.WEIGHT || null;
                this.form.gender = info.GENDER || 'N';
                this.form.mainPhotoUrl = info.MAIN_PHOTO_URL || '';
                // 기존 좌표 보존 (있으면 재사용)
                this.form.lat = Number(info.LATITUDE || info.lat || info.LAT || '') || null;
                this.form.lng = Number(info.LONGITUDE || info.lng || info.LNG || '') || null;

                this.originalAddress = this.form.address || '';
                this.updatePreview();
                this.canEdit = (this.sessionId && this.sessionId === this.ownerId);
              }
            });

            // 2) 학력
            await $.ajax({
              url: 'http://localhost:3009/cms/customeredu',
              type: 'GET', dataType: 'json',
              data: { memberNo: this.memberNo },
              success: (res) => {
                const rows = Array.isArray(res) ? res : (res.list || []);
                this.educations = rows.map(r => ({
                  level: r.EDU_LEVEL || r.LEVEL || '',
                  school: r.SCHOOLNAME || r.SCHOOL || '',
                  major: r.MAJOR || '',
                  enter: r.ENTER_YEAR || r.ENTER || '',
                  graduate: r.GRAD_YEAR || r.GRADUATE || '',
                  area: r.AREA || ''
                }));
              }
            });
          } catch (e) {
            console.error(e); alert('데이터 로딩 실패');
          }
        },

        // ===== 주소검색 팝업 =====
        fnSearchAddr() {
          window.open('/client/jusoPopup.html?v=' + Date.now(), 'addr', 'width=500,height=600,scrollbars=yes,resizable=yes');
        },
        fnResult(roadFullAddr, roadAddrPart1, addrDetail, engAddr) {
          this.form.address = roadFullAddr || roadAddrPart1 || '';
          // 주소 바꾸면 좌표는 무효화해서 다시 만들게 함
          this.form.lat = null; this.form.lng = null;
        },

        // ===== 검증 =====
        // validate(){
        //   if(!this.canEdit){ alert('수정 권한이 없습니다.'); return false; }
        //   if(!this.form.name?.trim()){ alert('성명을 입력하세요.'); return false; }
        //   if(!this.form.address?.trim()){ alert('주소를 입력(검색)하세요.'); return false; }
        //   return true;
        // },

        // ===== 서버 payload =====
        eduPayload() {
          return this.educations.map(e => ({
            EDU_LEVEL: e.level || null,
            SCHOOLNAME: e.school || null,
            MAJOR: e.major || null,
            ENTER_YEAR: e.enter ? Number(e.enter) : null,
            GRAD_YEAR: e.graduate ? Number(e.graduate) : null,
            AREA: e.area || null
          }));
        },

        makeParam(geo) {
          const lat = (geo && geo.lat != null) ? geo.lat : (this.form.lat ?? '');
          const lng = (geo && geo.lng != null) ? geo.lng : (this.form.lng ?? '');
          return {
            memberNo: this.form.memberNo,
            name: this.form.name,
            pr: this.form.pr,
            address: this.form.address,
            email: this.form.email,
            phone: this.form.phone,
            birthYear: this.form.birthYear ?? '',
            height: this.form.height ?? '',
            weight: this.form.weight ?? '',
            gender: this.form.gender || 'N',
            mainPhotoUrl: this.form.mainPhotoUrl || '',
            lat, lng
          };
        },

        // ===== 파일 업로드(선택) → cb(uploadedPath|null) =====
        fnUploadImg(cb) {
          const fileInput = this.$refs.fileInput;
          if (!fileInput || fileInput.files.length === 0) { cb(null); return; }
          const fd = new FormData();
          fd.append('image', fileInput.files[0]);
          $.ajax({
            url: 'http://localhost:3009/upload',
            method: 'POST',
            data: fd, processData: false, contentType: false,
            success: (res) => {
              const path = (res && res.path) ? String(res.path).replace(/\\/g, '/') : null;
              cb(path);
            },
            error: (err) => { console.error(err); alert('업로드 실패(기존 사진 유지)'); cb(null); }
          });
        },

        // ===== 주소 → 좌표 (네이버 JS SDK, 콜백) =====
        geocodeClientCb(addr, cb) {
          if (!addr || !(window.naver && naver.maps && naver.maps.Service)) { cb(null); return; }
          naver.maps.Service.geocode({ query: addr }, function (status, res) {
            if (status !== naver.maps.Service.Status.OK || !res?.v2?.addresses?.length) { cb(null); return; }
            const a = res.v2.addresses[0];
            cb({ lat: parseFloat(a.y), lng: parseFloat(a.x) });
          });
        },

        // ===== 저장 플로우 (순차) =====
        save() {
          // if(!this.validate()) return;
          const self = this;
          const addr = (self.form.address || '').trim();

          // 1) (선택) 사진 업로드
          self.fnUploadImg(function (uploadedPath) {
            if (uploadedPath) {
              self.form.mainPhotoUrl = uploadedPath;
              self.updatePreview();
            }

            let hasCoord = v => (typeof v === 'number') && Number.isFinite(v);
            // 2) (필요 시) 지오코딩
            let needGeocode = !!addr && !(hasCoord(self.form.lat) && hasCoord(self.form.lng));
            const afterGeo = function (geo) {
              // 3) 프로필 업데이트
              const param = self.makeParam(geo);
              $.ajax({
                url: 'http://localhost:3009/cms/customerupdate',
                type: 'GET', dataType: 'json', data: param,
                success: function () {
                  // 4) 학력 replace
                  $.ajax({
                    url: 'http://localhost:3009/cms/customeredu/replace',
                    type: 'GET', dataType: 'json',
                    data: { memberNo: self.form.memberNo, list: JSON.stringify(self.eduPayload()) },
                    traditional: true,
                    success: function () {
                      alert('수정되었습니다.');
                      self.goDetail();
                    },
                    error: function (e) { console.error(e); alert('학력 저장 실패'); }
                  });
                },
                error: function (e) { console.error(e); alert('프로필 저장 실패'); }
              });
            };

            if (needGeocode) {
              self.geocodeClientCb(addr, function (geo) {
                if (!geo) { alert('주소 지오코딩(위도/경도) 실패'); return; }
                // 메모리에도 좌표 갱신해 둔다(다음 저장 시 재사용)
                self.form.lat = geo.lat; self.form.lng = geo.lng;
                afterGeo(geo);
              });
            } else {
              afterGeo({ lat: self.form.lat, lng: self.form.lng });
            }
          });
        },

        goDetail() { location.href = `cms_customer_view.html?memberNo=${encodeURIComponent(this.form.memberNo)}`; },
        goList() { location.href = `cms_customer_list.html`; }

      }
    });

    app.mount('#app');

    // ----- jusoPopup 콜백 -----
    function jusoCallBack(roadFullAddr, roadAddrPart1, addrDetail, engAddr) {
      if (window.vueObj) window.vueObj.fnResult(roadFullAddr, roadAddrPart1, addrDetail, engAddr);
    }
  </script>
</body>

</html>